<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipedrive 거래 생성 테스트</title>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f8f8;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1cc7b6;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-bottom: 10px;
        }
        button {
            background: #1cc7b6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #189a8c;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Pipedrive 거래 생성 테스트</h1>
        
        <div class="test-section">
            <h3>1. 기본 테스트</h3>
            <p>이훈수 담당자로 테스트 거래를 생성합니다.</p>
            <button onclick="testBasicDeal()">기본 거래 생성 테스트</button>
            <div id="basic-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. 실제 견적서 데이터로 테스트</h3>
            <p>실제 견적서 데이터를 사용하여 거래를 생성합니다.</p>
            <button onclick="testRealDeal()">실제 데이터 테스트</button>
            <div id="real-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. 설정 확인</h3>
            <p>현재 Pipedrive 설정을 확인합니다.</p>
            <button onclick="checkConfig()">설정 확인</button>
            <div id="config-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 파이프라인 목록 확인</h3>
            <p>사용 가능한 Pipedrive 파이프라인 목록을 확인합니다.</p>
            <button onclick="checkPipelines()">파이프라인 목록 확인</button>
            <div id="pipelines-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. 파이프라인 4 스테이지 확인</h3>
            <p>견적서생성 파이프라인(4)의 스테이지 목록을 확인합니다.</p>
            <button onclick="checkStages(4)">스테이지 목록 확인</button>
            <div id="stages-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        async function testBasicDeal() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '테스트 중...';

            try {
                const response = await fetch('http://localhost:9000/test-pipedrive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ 성공!\n\n${result.message}\n\n거래 ID: ${result.deal_id}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 실패!\n\n${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 오류 발생!\n\n${error.message}`;
            }
        }

        async function testRealDeal() {
            const resultDiv = document.getElementById('real-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '실제 데이터로 테스트 중...';

            try {
                // 실제 견적서 데이터
                const realData = {
                    estimate_date: "2025-01-20",
                    estimate_number: "DLP250120-1",
                    supplier_person: "애니트론사업부 이훈수 이사",
                    supplier_contact: "hslee@bitekps.com / 010-3252-0593",
                    receiver_company: "테스트기업(주)",
                    receiver_person: "김테스트",
                    receiver_contact: "test@company.com",
                    delivery_date: "입금확인일로부터 2주 이내",
                    product_category: "장비",
                    products: [
                        {
                            type: "컬러라벨프린터",
                            name: "1050 5색",
                            detail: "산업용 레이저 컬러라벨프린터 CMYKW 5색",
                            qty: 1,
                            price: 12000000,
                            total: 12000000,
                            note: "테스트"
                        }
                    ]
                };

                const response = await fetch('http://localhost:9000/collect-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(realData)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ 성공!\n\n${result.message}\n\nPipedrive 거래 ID: ${result.pipedrive_deal_id || '생성되지 않음'}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 실패!\n\n${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 오류 발생!\n\n${error.message}`;
            }
        }

        async function checkConfig() {
            const resultDiv = document.getElementById('config-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '설정 확인 중...';

            try {
                const response = await fetch('http://localhost:9000/pipedrive-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const config = await response.json();
                
                let configText = `📋 현재 설정 확인\n\n`;
                configText += `✅ API 토큰: ${config.api_token}\n`;
                configText += `✅ 도메인: ${config.domain}\n`;
                configText += `✅ 파이프라인 ID: ${config.pipeline_id}\n`;
                configText += `✅ 스테이지 ID: ${config.stage_id}\n\n`;
                
                configText += `✅ Pipedrive 사용자 매핑:\n`;
                for (const [name, id] of Object.entries(config.user_mapping)) {
                    configText += `- ${name} → 사용자 ID ${id}\n`;
                }
                
                configText += `\n✅ 설정 파일 상태: pipedrive_config_local.py 로드됨`;
                
                resultDiv.className = 'result success';
                resultDiv.textContent = configText;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 설정 확인 실패!\n\n${error.message}`;
            }
        }

        async function checkPipelines() {
            const resultDiv = document.getElementById('pipelines-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '파이프라인 목록 확인 중...';

            try {
                const response = await fetch('http://localhost:9000/pipedrive-pipelines', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    let pipelinesText = `📋 사용 가능한 파이프라인 목록\n\n`;
                    
                    for (const pipeline of result.pipelines) {
                        const status = pipeline.active ? '✅ 활성' : '❌ 비활성';
                        pipelinesText += `${status} ID: ${pipeline.id} - ${pipeline.name}\n`;
                    }
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = pipelinesText;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 파이프라인 목록 조회 실패!\n\n${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 파이프라인 목록 조회 오류!\n\n${error.message}`;
            }
        }

        async function checkStages(pipelineId) {
            const resultDiv = document.getElementById('stages-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '스테이지 목록 확인 중...';

            try {
                const response = await fetch(`http://localhost:9000/pipedrive-stages/${pipelineId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    let stagesText = `📋 파이프라인 ${pipelineId} 스테이지 목록\n\n`;
                    
                    for (const stage of result.stages) {
                        const status = stage.active ? '✅ 활성' : '❌ 비활성';
                        stagesText += `${status} ID: ${stage.id} - ${stage.name} (순서: ${stage.order_nr})\n`;
                    }
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = stagesText;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 스테이지 목록 조회 실패!\n\n${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 스테이지 목록 조회 오류!\n\n${error.message}`;
            }
        }
    </script>
</body>
</html> 