<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²¬ì ë‚´ìš© ì…ë ¥ - í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ë²„ì „</title>
  <style>
    body { 
      background: #f8f8f8; 
      margin: 0;
      padding: 20px;
      font-family: 'Pretendard', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
    }
    .container { 
      max-width: 480px; 
      margin: 20px auto; 
      border-radius: 24px; 
      border: 1px solid #eee; 
      padding: 32px; 
      background: #fff; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 { 
      text-align: center; 
      margin-bottom: 32px; 
      color: #2c3e50;
      font-size: 1.8em;
      font-weight: 700;
    }
    .test-badge {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.7em;
      margin-left: 8px;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
      display: inline-block;
      transform: rotate(-5deg);
    }
    label { 
      color: #1cc7b6; 
      font-weight: bold; 
      display: block;
      margin-bottom: 6px;
      font-size: 0.95em;
    }
    input, select { 
      width: 100%; 
      padding: 12px; 
      margin-top: 4px; 
      margin-bottom: 16px;
      border-radius: 8px; 
      border: 2px solid #e1e8ed; 
      box-sizing: border-box;
      font-size: 0.95em;
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #1cc7b6;
      box-shadow: 0 0 0 3px rgba(28, 199, 182, 0.1);
    }
    hr { 
      margin: 24px 0; 
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, #1cc7b6, transparent);
    }
    .section-title { 
      color: #1cc7b6; 
      font-weight: bold; 
      margin-bottom: 16px; 
      font-size: 1.1em;
      border-left: 4px solid #1cc7b6;
      padding-left: 12px;
      background: rgba(28, 199, 182, 0.05);
      padding: 8px 12px;
      border-radius: 6px;
    }
    .product-set { 
      border: 2px solid #f1f3f4; 
      padding: 20px; 
      margin-top: 16px; 
      border-radius: 12px; 
      position: relative; 
      background: #fafbfc;
      transition: all 0.3s ease;
    }
    .product-set:hover {
      border-color: #1cc7b6;
      box-shadow: 0 2px 12px rgba(28, 199, 182, 0.1);
    }
    .product-set > div:first-child { 
      font-weight: bold; 
      margin-bottom: 16px; 
      color: #2c3e50;
      font-size: 1.05em;
    }
    .remove-btn { 
      float: right; 
      background: #ff4757; 
      color: white;
      border: none; 
      border-radius: 6px; 
      padding: 4px 12px; 
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.3s ease;
    }
    .remove-btn:hover {
      background: #ff3742;
      transform: translateY(-1px);
    }
    .product-row { 
      display: flex; 
      gap: 12px; 
      margin-bottom: 12px; 
      align-items: center;
    }
    .product-row input, .product-row select { 
      flex: 1; 
      margin-top: 0; 
      margin-bottom: 0;
    }
    .add-btn { 
      margin-top: 16px; 
      background: linear-gradient(45deg, #1cc7b6, #17a2b8); 
      color: #fff; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 8px; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(28, 199, 182, 0.3);
    }
    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(28, 199, 182, 0.4);
    }
    .add-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .preview-btn { 
      width: 100%; 
      margin-top: 32px; 
      background: linear-gradient(45deg, #1cc7b6, #17a2b8); 
      color: #fff; 
      border: none; 
      padding: 16px 0; 
      border-radius: 12px; 
      font-size: 1.2em; 
      cursor: pointer;
      font-weight: 700;
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(28, 199, 182, 0.4);
    }
    .preview-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(28, 199, 182, 0.5);
    }
    
    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ í–¥ìƒ */
    .loading {
      position: relative;
      background: linear-gradient(45deg, #1cc7b6, #17a2b8) !important;
      color: transparent !important;
      pointer-events: none;
      transform: scale(0.98);
      box-shadow: 0 4px 16px rgba(28, 199, 182, 0.5);
      transition: all 0.3s ease;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 28px;
      height: 28px;
      margin: -14px 0 0 -14px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ë²„íŠ¼ ë¹„í™œì„±í™” ìƒíƒœ í–¥ìƒ */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    /* ì²˜ìŒí™”ë©´ìœ¼ë¡œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í–¥ìƒ */
    .home-button {
      width: 100%;
      margin-top: 16px;
      background: #f8f9fa;
      color: #6c757d;
      border: 2px solid #dee2e6;
      padding: 12px 0;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      text-align: center;
      display: block;
      font-weight: 500;
    }
    
    .home-button:hover {
      background: #e9ecef;
      color: #495057;
      border-color: #adb5bd;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* í–¥ìƒëœ í¼ ìŠ¤íƒ€ì¼ë§ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group-inline {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .form-group-inline label {
      min-width: 80px;
      margin-bottom: 0;
      flex-shrink: 0;
    }

    .form-group-inline input,
    .form-group-inline select {
      margin-bottom: 0;
    }

    .supplier-id {
      width: 40px !important;
      text-align: center;
      background: #f8f9fa !important;
      border: 2px solid #e9ecef !important;
      font-weight: bold;
      color: #495057;
    }

    .readonly-input {
      background: #f8f9fa !important;
      border: 2px solid #e9ecef !important;
      color: #495057;
    }

    /* ê²¬ì ì œí’ˆ ì„ íƒ ê°•ì¡° ìŠ¤íƒ€ì¼ */
    .product-category-section {
      background: #fff8e1;
      border: 2px solid #ffecb3;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .product-category-section label {
      color: #f57f17;
      font-size: 1.1em;
    }

    .product-category-section select {
      border: 2px solid #ffb74d;
    }

    .product-category-section select:focus {
      border-color: #f57f17;
      box-shadow: 0 0 0 3px rgba(245, 127, 23, 0.1);
    }

    /* ëŒ€ë¶„ë¥˜ ì„ íƒ ê°•ì¡° ìŠ¤íƒ€ì¼ - TEST ë²„ì „ í•µì‹¬ ê¸°ëŠ¥ */
    .major-category-section {
      background: linear-gradient(135deg, #e8f5e8, #f0fff0);
      border: 3px solid #4caf50;
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
      position: relative;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
    }

    .major-category-section::before {
      content: "ğŸ†• NEW FEATURE";
      position: absolute;
      top: -12px;
      left: 20px;
      background: #4caf50;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .major-category-section label {
      color: #2e7d32;
      font-size: 1.2em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .major-category-section select {
      border: 3px solid #81c784;
      background: white;
      font-size: 1.05em;
      padding: 14px;
    }

    .major-category-section select:focus {
      border-color: #4caf50;
      box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.15);
    }

    .major-category-help {
      font-size: 0.85em;
      color: #2e7d32;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 6px;
      border-left: 4px solid #4caf50;
    }

    /* ìˆ˜ì‹ ì ì •ë³´ ìŠ¤íƒ€ì¼ë§ */
    .receiver-section {
      background: #f0f8ff;
      border: 2px solid #b3d9ff;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }

    .receiver-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .receiver-info label {
      min-width: 70px;
      margin-bottom: 0;
      color: #1565c0;
    }

    .receiver-info input {
      flex: 1;
      margin-bottom: 0;
    }

    /* ì œí’ˆì •ë³´ ì„¹ì…˜ í–¥ìƒ */
    .products-section {
      background: #fafafa;
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
      border: 2px solid #e0e0e0;
    }

    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .product-counter {
      background: #1cc7b6;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }

    /* ë‚©ê¸°ì¼ ìŠ¤íƒ€ì¼ë§ */
    .delivery-section {
      background: #fff3e0;
      border: 2px solid #ffcc80;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .delivery-section label {
      color: #e65100;
      font-size: 1.1em;
    }

    /* ì†Œëª¨í’ˆ ëª¨ë¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .consumable-model {
      border: 2px solid #ff9800 !important;
      background: #fff8e1 !important;
    }

    .consumable-model:focus {
      border-color: #f57f17 !important;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1) !important;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 600px) {
      .container {
        max-width: 100%;
        margin: 10px;
        padding: 20px;
      }

      .form-group-inline {
        flex-direction: column;
        align-items: stretch;
      }

      .form-group-inline label {
        min-width: auto;
      }

      .receiver-info {
        flex-direction: column;
        align-items: stretch;
      }

      .receiver-info label {
        min-width: auto;
      }

      .product-row {
        flex-direction: column;
      }
    }

    /* ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bounce-in {
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* í•„ìˆ˜ í•„ë“œ í‘œì‹œ ê°œì„  */
    .required::after {
      content: " *";
      color: #e74c3c;
      font-weight: bold;
    }

    /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .tooltip {
      position: relative;
      cursor: help;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8em;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* ì„±ê³µ/ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .success-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
  </style>
</head>
<body>
<div class="container fade-in">
  <h2>ê²¬ì ë‚´ìš© ì…ë ¥ <span class="test-badge">ENHANCED TEST</span></h2>
  
  <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
  <div class="form-group">
    <label class="required">ê²¬ì ì¼ì</label>
    <input type="date" id="date" class="tooltip" data-tooltip="ê²¬ì ì„œ ë°œí–‰ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”">
  </div>
  
  <div class="form-group">
    <label class="required">ê²¬ì ë²ˆí˜¸</label>
    <input type="text" id="number" placeholder="ì˜ˆì‹œ) DLP_250707-1" class="tooltip" data-tooltip="ìë™ ìƒì„±ë˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤">
  </div>
  
  <hr>
  
  <!-- ê³µê¸‰ì ì •ë³´ ì„¹ì…˜ -->
  <div class="form-group">
    <div class="section-title">ğŸ¢ ê³µê¸‰ì ì •ë³´</div>
    <div style="margin-bottom: 16px; padding: 12px; background: #e8f5e8; border-radius: 8px;">
      <strong>ê³µê¸‰ì: (ì£¼)ë°”ì´í…í…Œí¬ë†€ë¡œì§€</strong>
    </div>
    
    <div class="form-group-inline">
      <label>ë‹´ë‹¹ì</label>
      <select id="supplier-person" required style="flex: 2;">
        <option value="" data-contact="" data-id="" disabled selected hidden>ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì´í›ˆìˆ˜ ì´ì‚¬" data-contact="hslee@bitekps.com / 010-3252-0593" data-id="A">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì´í›ˆìˆ˜ ì´ì‚¬</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì°¨ì¬ì› ì°¨ì¥" data-contact="cjw@bitekps.com / 010-5035-7791" data-id="B">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì°¨ì¬ì› ì°¨ì¥</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ í•˜ì² ìš© ì°¨ì¥" data-contact="cyha@bitekps.com / 010-6206-7656" data-id="C">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ í•˜ì² ìš© ì°¨ì¥</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ë…¸ì¬ìµ ì°¨ì¥" data-contact="jake@bitekps.com / 010-6419-0945" data-id="D">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ë…¸ì¬ìµ ì°¨ì¥</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì „ì¤€ì˜ ê³¼ì¥" data-contact="methu@bitekps.com / 010-2866-4914" data-id="E">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì „ì¤€ì˜ ê³¼ì¥</option>
        <option value="ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì¥ì§„í˜¸ ëŒ€ë¦¬" data-contact="jhjang@bitekps.com / 010-9999-4401" data-id="F">ì• ë‹ˆíŠ¸ë¡ ì‚¬ì—…ë¶€ ì¥ì§„í˜¸ ëŒ€ë¦¬</option>
      </select>
      <input id="supplier-person-id" type="text" class="supplier-id" readonly placeholder="ID" title="ë‹´ë‹¹ì ID">
    </div>

    <div class="form-group">
      <label>ì—°ë½ì²˜</label>
      <input id="supplier-contact" type="text" class="readonly-input" readonly placeholder="ë‹´ë‹¹ì ì—°ë½ì²˜ê°€ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤">
    </div>
  </div>
  
  <hr>
  
  <!-- ìˆ˜ì‹ ì ì •ë³´ ì„¹ì…˜ -->
  <div class="receiver-section">
    <div class="section-title">ğŸ‘¤ ìˆ˜ì‹ ì ì •ë³´</div>
    <div class="receiver-info">
      <label class="required">íšŒì‚¬ëª…</label>
      <input type="text" id="receiver-company" placeholder="ìˆ˜ì‹ ì íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
    </div>
    <div class="receiver-info">
      <label>ë‹´ë‹¹ì</label>
      <input type="text" id="receiver-person" placeholder="ìˆ˜ì‹ ì ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
    </div>
    <div class="receiver-info">
      <label>ì—°ë½ì²˜</label>
      <input type="text" id="receiver-contact" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
    </div>
  </div>
  
  <!-- ê²¬ì ì œí’ˆ ì„ íƒ ì„¹ì…˜ -->
  <div class="product-category-section">
    <label class="required">ğŸ“‹ ê²¬ì ì œí’ˆ ì„ íƒ</label>
    <select id="product-category" required>
      <option value="">ê²¬ì ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
      <option value="ì¥ë¹„">ğŸ–¨ï¸ ì¥ë¹„</option>
      <option value="ì†Œëª¨í’ˆ">ğŸ”§ ì†Œëª¨í’ˆ</option>
      <option value="ê¸°íƒ€">ğŸ“¦ ê¸°íƒ€</option>
    </select>
  </div>
  
  <!-- ì œí’ˆ ëŒ€ë¶„ë¥˜ ì„ íƒ ì„¹ì…˜ - TEST ë²„ì „ í•µì‹¬ ê¸°ëŠ¥ -->
  <div class="major-category-section bounce-in">
    <label class="required">ğŸ·ï¸ ì œí’ˆ ëŒ€ë¶„ë¥˜</label>
    <select id="major-category" class="product-major-category" required>
      <option value="">ì œí’ˆ ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
      <option value="ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°">ğŸ–¨ï¸ ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°</option>
      <option value="ë””ì§€í„¸íŒ¨í‚¤ì§•ì¥ë¹„">ğŸ“¦ ë””ì§€í„¸íŒ¨í‚¤ì§•ì¥ë¹„</option>
      <option value="ë°”ì½”ë“œë¼ë²¨í”„ë¦°í„°">ğŸ·ï¸ ë°”ì½”ë“œë¼ë²¨í”„ë¦°í„°</option>
      <option value="ì†Œëª¨í’ˆ">ğŸ”§ ì†Œëª¨í’ˆ</option>
      <option value="ê¸°íƒ€ì¥ë¹„">âš™ï¸ ê¸°íƒ€ì¥ë¹„</option>
      <option value="íŠ¹ìˆ˜ì¥ë¹„">ğŸ”¬ íŠ¹ìˆ˜ì¥ë¹„</option>
      <option value="ë§ì¶¤í˜•ì†”ë£¨ì…˜">ğŸ’¼ ë§ì¶¤í˜•ì†”ë£¨ì…˜</option>
    </select>
    <div class="major-category-help">
      â„¹ï¸ <strong>í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥:</strong> ì œí’ˆ ëŒ€ë¶„ë¥˜ë¥¼ í†µí•´ ë” ì •í™•í•œ ê²¬ì ì„œ ë¶„ë¥˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ í…ŒìŠ¤íŠ¸ ë²„ì „ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
  </div>
  
  <hr>
  
  <!-- ì œí’ˆì •ë³´ ì„¹ì…˜ -->
  <div class="products-section">
    <div class="products-header">
      <div class="section-title">ğŸ“ ì œí’ˆì •ë³´</div>
      <div class="product-counter" id="product-counter">0 / 8</div>
    </div>
    <div id="products-area"></div>
    <button type="button" id="add-product" class="add-btn">â• ì œí’ˆ ì¶”ê°€</button>
  </div>
    
  <!-- ë‚©ê¸°ì¼ ì„¹ì…˜ -->
  <div class="delivery-section">
    <label class="required">ğŸšš ë‚©ê¸°ì¼</label>
    <input type="text" id="delivery-date" placeholder="ë‚©ê¸°ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" value="ì…ê¸ˆí™•ì¸ì¼ë¡œë¶€í„° 2ì£¼ ì´ë‚´">
  </div>
  
  <button type="button" class="preview-btn" id="preview-btn">ğŸ” ê²¬ì ì„œ ìƒì„±í•˜ê¸°</button>
  
  <!-- ì²˜ìŒí™”ë©´ìœ¼ë¡œ ë²„íŠ¼ -->
  <a href="/" class="home-button">ğŸ  ì²˜ìŒí™”ë©´ìœ¼ë¡œ</a>
</div>

<script>
console.log("=== ENHANCED TEST VERSION ë¡œë“œ ì¤‘ ===");

// 1. í™•ì¥ëœ ë°ì´í„° êµ¬ì¡°í™”
const productData = {
  "ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°": [
    { name: "1040 4ìƒ‰", detail: "ì‚°ì—…ìš© ë ˆì´ì € ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° CMYK 4ìƒ‰ ì§€ì›", price: 10000000, category: "ê³ ê¸‰í˜•" },
    { name: "1050 5ìƒ‰", detail: "ì‚°ì—…ìš© ë ˆì´ì € ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° CMYKW 5ìƒ‰ ì§€ì›", price: 12000000, category: "ìµœê³ ê¸‰í˜•" },
    { name: "EPSON CW-C4040A(4ì¸ì¹˜)", detail: "4ì¸ì¹˜ ì‰í¬ì ¯ ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ì¤‘ì†Œê¸°ì—…ìš©", price: 2990000, category: "í‘œì¤€í˜•" },
    { name: "EPSON CW-C6040A(4ì¸ì¹˜)", detail: "4ì¸ì¹˜ ê³ ì„±ëŠ¥ ì‰í¬ì ¯ ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ê³ ì†ì¸ì‡„", price: 2000000, category: "ê³ ì„±ëŠ¥í˜•" },
    { name: "EPSON CW-C6540A(8ì¸ì¹˜)", detail: "8ì¸ì¹˜ ê³ ì„±ëŠ¥ ì‰í¬ì ¯ ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ëŒ€í˜•ë¼ë²¨", price: 3000000, category: "ëŒ€í˜•ìš©" },
    { name: "AT-1", detail: "ë””ì§€í„¸ ë ˆì´ì € ë‚±ì¥í˜• ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ë§ì¶¤í˜•", price: 9900000, category: "ë§ì¶¤í˜•" },
    { name: "CL-2000", detail: "ê³ ì† ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ëŒ€ëŸ‰ìƒì‚°ìš©", price: 15000000, category: "ì‚°ì—…ìš©" },
    { name: "MINI-COLOR", detail: "ì†Œí˜• ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„° - ì‚¬ë¬´ìš©", price: 800000, category: "ì†Œí˜•" }
  ],
  "ë””ì§€í„¸íŒ¨í‚¤ì§•ì¥ë¹„": [
    { name: "ANY-PACK", detail: "ë””ì§€í„¸ ë ˆì´ì € ë‚±ì¥í˜• í’€ì»¬ëŸ¬ì¸ì‡„ íŒ¨í‚¤ì§• í”„ë¦°í„°", price: 30000000, category: "í‘œì¤€í˜•" },
    { name: "PACK-PRO", detail: "ê³ ê¸‰í˜• ë””ì§€í„¸ íŒ¨í‚¤ì§• ì†”ë£¨ì…˜ - ìë™ì ˆë‹¨ í¬í•¨", price: 45000000, category: "ê³ ê¸‰í˜•" },
    { name: "ECO-PACK", detail: "ì¹œí™˜ê²½ ë””ì§€í„¸ íŒ¨í‚¤ì§• ì¥ë¹„ - ì—ì½” ì†”ë£¨ì…˜", price: 25000000, category: "ì¹œí™˜ê²½" },
    { name: "SMART-PACK", detail: "AI ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ íŒ¨í‚¤ì§• ì‹œìŠ¤í…œ", price: 60000000, category: "ìŠ¤ë§ˆíŠ¸" }
  ],
  "ë°”ì½”ë“œë¼ë²¨í”„ë¦°í„°": [
    { name: "BT-200", detail: "ì—´ì „ì‚¬/ê°ì—´ë°©ì‹ ë°”ì½”ë“œë¼ë²¨ í”„ë¦°í„° - í‘œì¤€í˜•", price: 2500000, category: "í‘œì¤€í˜•" },
    { name: "BT-100", detail: "ì—´ì „ì‚¬/ê°ì—´ë°©ì‹ ë°”ì½”ë“œë¼ë²¨ í”„ë¦°í„° - ê¸°ë³¸í˜•", price: 2000000, category: "ê¸°ë³¸í˜•" },
    { name: "BT-300", detail: "ê³ ì† ë°”ì½”ë“œë¼ë²¨ í”„ë¦°í„° - ëŒ€ëŸ‰ì¸ì‡„ìš©", price: 3200000, category: "ê³ ì†í˜•" },
    { name: "BT-MOBILE", detail: "íœ´ëŒ€ìš© ë°”ì½”ë“œë¼ë²¨ í”„ë¦°í„°", price: 800000, category: "íœ´ëŒ€ìš©" },
    { name: "BT-INDUSTRIAL", detail: "ì‚°ì—…ìš© ë°”ì½”ë“œë¼ë²¨ í”„ë¦°í„° - ê³ ë‚´êµ¬ì„±", price: 4500000, category: "ì‚°ì—…ìš©" }
  ],
  "íŠ¹ìˆ˜ì¥ë¹„": [
    { name: "UV-PRINTER", detail: "UV ê²½í™” íŠ¹ìˆ˜ ë¼ë²¨í”„ë¦°í„°", price: 20000000, category: "íŠ¹ìˆ˜ì¸ì‡„" },
    { name: "HOLOGRAM-PRINTER", detail: "í™€ë¡œê·¸ë¨ ë³´ì•ˆë¼ë²¨ í”„ë¦°í„°", price: 35000000, category: "ë³´ì•ˆì¸ì‡„" },
    { name: "RFID-PRINTER", detail: "RFID íƒœê·¸ ì¸ì‡„ ì¥ë¹„", price: 18000000, category: "ìŠ¤ë§ˆíŠ¸ë¼ë²¨" }
  ],
  "ì†Œëª¨í’ˆ-ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°": [
    { name: "1040/1050 í† ë„ˆ", detail: "CYAN í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€(ë†ë„20% A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤ ì‚¬ìš©)", price: 225000, color: "CYAN" },
    { name: "1040/1050 í† ë„ˆ", detail: "MAGENTA í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€(ë†ë„20% A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤ ì‚¬ìš©)", price: 225000, color: "MAGENTA" },
    { name: "1040/1050 í† ë„ˆ", detail: "YELLOW í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€(ë†ë„20% A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤ ì‚¬ìš©)", price: 225000, color: "YELLOW" },
    { name: "1040/1050 í† ë„ˆ", detail: "BLACK í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€(ë†ë„20% A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤ ì‚¬ìš©)", price: 225000, color: "BLACK" },
    { name: "1040/1050 í† ë„ˆ", detail: "WHITE í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€(íŠ¹ìˆ˜ìš©ë„)", price: 300000, color: "WHITE" },
    { name: "ì •ì°©ê¸° ìœ ë‹›", detail: "1040/1050ìš© ì •ì°©ê¸°(Fuser Unit)", price: 450000, type: "ë¶€í’ˆ" },
    { name: "ì „ì‚¬ë²¨íŠ¸", detail: "1040/1050ìš© ì „ì‚¬ë²¨íŠ¸(Transfer Belt)", price: 320000, type: "ë¶€í’ˆ" },
    { name: "íí† ë„ˆí†µ", detail: "1040/1050ìš© íí† ë„ˆ ìˆ˜ì§‘í†µ", price: 80000, type: "ë¶€í’ˆ" }
  ]
};

// í™•ì¥ëœ ì†Œëª¨í’ˆë³„ ì œí’ˆëª… ë§¤í•‘
const consumableProducts = {
  "1040 4ìƒ‰": [
    "1040 CYAN TONER",
    "1040 MAGENTA TONER", 
    "1040 YELLOW TONER",
    "1040 BLACK TONER",
    "1040 Fuser(ì •ì°©ê¸°)",
    "1040 Transfer Belt(ì „ì‚¬ë²¨íŠ¸)",
    "1040 íí† ë„ˆí†µ",
    "1040 ì²­ì†Œí‚¤íŠ¸",
    "1040 ë“œëŸ¼ìœ ë‹›"
  ],
  "1050 5ìƒ‰": [
    "1050 CYAN TONER",
    "1050 MAGENTA TONER",
    "1050 YELLOW TONER", 
    "1050 BLACK TONER",
    "1050 WHITE TONER",
    "1050 Fuser(ì •ì°©ê¸°)",
    "1050 Transfer Belt(ì „ì‚¬ë²¨íŠ¸)",
    "1050 íí† ë„ˆí†µ",
    "1050 ì²­ì†Œí‚¤íŠ¸",
    "1050 ë“œëŸ¼ìœ ë‹›"
  ],
  "EPSON CW-C4040A": [
    "C4040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK",
    "C4040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR",
    "C4040A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤",
    "C4040A ì»·í„°ë¸”ë ˆì´ë“œ",
    "íì‰í¬ë°•ìŠ¤"
  ],
  "EPSON CW-C6040A": [
    "C6040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK",
    "C6040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR", 
    "C6040A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤",
    "C6040A ì»·í„°ë¸”ë˜ì´ë“œ",
    "íì‰í¬ë°•ìŠ¤"
  ],
  "EPSON CW-C6540A": [
    "C6540A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK",
    "C6540A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR",
    "C6540A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤",
    "C6540A ì»·í„°ë¸”ë˜ì´ë“œ",
    "íì‰í¬ë°•ìŠ¤"
  ]
};

const consumableModelList = ["1040 4ìƒ‰", "1050 5ìƒ‰", "EPSON CW-C4040A", "EPSON CW-C6040A", "EPSON CW-C6540A"];

// í™•ì¥ëœ ì†Œëª¨í’ˆë³„ ì œí’ˆëª…, ìƒì„¸ì •ë³´, ë‹¨ê°€ ë§¤í•‘
const consumableProductDetails = {
  "1040 CYAN TONER": { detail: "1040ìš© ì‹œì•ˆ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 MAGENTA TONER": { detail: "1040ìš© ë§ˆì  íƒ€ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 YELLOW TONER": { detail: "1040ìš© ì˜ë¡œìš° í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 BLACK TONER": { detail: "1040ìš© ë¸”ë™ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 Fuser(ì •ì°©ê¸°)": { detail: "1040ìš© ì •ì°©ê¸° ìœ ë‹› (ì•½ 100,000ë§¤ êµì²´ì£¼ê¸°)", price: 450000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 Transfer Belt(ì „ì‚¬ë²¨íŠ¸)": { detail: "1040ìš© ì „ì‚¬ë²¨íŠ¸ (ì•½ 50,000ë§¤ êµì²´ì£¼ê¸°)", price: 320000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 íí† ë„ˆí†µ": { detail: "1040ìš© íí† ë„ˆ ìˆ˜ì§‘í†µ", price: 80000, stock: "ì¬ê³ ìˆìŒ" },
  "1040 ì²­ì†Œí‚¤íŠ¸": { detail: "1040ìš© ì²­ì†Œ ë° ìœ ì§€ë³´ìˆ˜ í‚¤íŠ¸", price: 120000, stock: "ì£¼ë¬¸ì‹œ" },
  "1040 ë“œëŸ¼ìœ ë‹›": { detail: "1040ìš© ë“œëŸ¼ ìœ ë‹› (ì•½ 30,000ë§¤ êµì²´ì£¼ê¸°)", price: 380000, stock: "ì¬ê³ ìˆìŒ" },
  
  "1050 CYAN TONER": { detail: "1050ìš© ì‹œì•ˆ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 MAGENTA TONER": { detail: "1050ìš© ë§ˆì  íƒ€ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 YELLOW TONER": { detail: "1050ìš© ì˜ë¡œìš° í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 BLACK TONER": { detail: "1050ìš© ë¸”ë™ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (A6 ê¸°ì¤€ ì•½ 9,000~10,000ë§¤)", price: 225000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 WHITE TONER": { detail: "1050ìš© í™”ì´íŠ¸ í† ë„ˆ ì¹´íŠ¸ë¦¬ì§€ (íŠ¹ìˆ˜ìš©ë„)", price: 300000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 Fuser(ì •ì°©ê¸°)": { detail: "1050ìš© ì •ì°©ê¸° ìœ ë‹› (ì•½ 100,000ë§¤ êµì²´ì£¼ê¸°)", price: 450000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 Transfer Belt(ì „ì‚¬ë²¨íŠ¸)": { detail: "1050ìš© ì „ì‚¬ë²¨íŠ¸ (ì•½ 50,000ë§¤ êµì²´ì£¼ê¸°)", price: 320000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 íí† ë„ˆí†µ": { detail: "1050ìš© íí† ë„ˆ ìˆ˜ì§‘í†µ", price: 80000, stock: "ì¬ê³ ìˆìŒ" },
  "1050 ì²­ì†Œí‚¤íŠ¸": { detail: "1050ìš© ì²­ì†Œ ë° ìœ ì§€ë³´ìˆ˜ í‚¤íŠ¸", price: 120000, stock: "ì£¼ë¬¸ì‹œ" },
  "1050 ë“œëŸ¼ìœ ë‹›": { detail: "1050ìš© ë“œëŸ¼ ìœ ë‹› (ì•½ 30,000ë§¤ êµì²´ì£¼ê¸°)", price: 380000, stock: "ì¬ê³ ìˆìŒ" },

  "C4040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK": { detail: "EPSON CW-C4040Aìš© ë¸”ë™ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 180000, stock: "ì¬ê³ ìˆìŒ" },
  "C4040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR": { detail: "EPSON CW-C4040Aìš© ì»¬ëŸ¬ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 280000, stock: "ì¬ê³ ìˆìŒ" },
  "C4040A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤": { detail: "EPSON CW-C4040Aìš© ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤", price: 120000, stock: "ì¬ê³ ìˆìŒ" },
  "C4040A ì»·í„°ë¸”ë ˆì´ë“œ": { detail: "EPSON CW-C4040Aìš© êµì²´ìš© ì»·í„°ë¸”ë ˆì´ë“œ", price: 45000, stock: "ì¬ê³ ìˆìŒ" },

  "C6040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK": { detail: "EPSON CW-C6040Aìš© ë¸”ë™ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 190000, stock: "ì¬ê³ ìˆìŒ" },
  "C6040A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR": { detail: "EPSON CW-C6040Aìš© ì»¬ëŸ¬ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 290000, stock: "ì¬ê³ ìˆìŒ" },
  "C6040A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤": { detail: "EPSON CW-C6040Aìš© ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤", price: 130000, stock: "ì¬ê³ ìˆìŒ" },
  "C6040A ì»·í„°ë¸”ë ˆì´ë“œ": { detail: "EPSON CW-C6040Aìš© êµì²´ìš© ì»·í„°ë¸”ë ˆì´ë“œ", price: 48000, stock: "ì¬ê³ ìˆìŒ" },
  
  // EPSON CW-C6540A ì†Œëª¨í’ˆ
  "C6540A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ BLACK": { detail: "EPSON CW-C6540Aìš© ë¸”ë™ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 180000, stock: "ì¬ê³ ìˆìŒ" },
  "C6540A ì‰í¬ì¹´íŠ¸ë¦¬ì§€ COLOR": { detail: "EPSON CW-C6540Aìš© ì»¬ëŸ¬ ì‰í¬ì¹´íŠ¸ë¦¬ì§€", price: 280000, stock: "ì¬ê³ ìˆìŒ" },
  "C6540A ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤": { detail: "EPSON CW-C6540Aìš© ë©”ì¸í„°ë„ŒìŠ¤ë°•ìŠ¤", price: 120000, stock: "ì¬ê³ ìˆìŒ" },
  "C6540A ì»·í„°ë¸”ë ˆì´ë“œ": { detail: "EPSON CW-C6540Aìš© êµì²´ìš© ì»·í„°ë¸”ë ˆì´ë“œ", price: 48000, stock: "ì¬ê³ ìˆìŒ" },
  
  // íì‰í¬ë°•ìŠ¤ (ëª¨ë“  EPSON ëª¨ë¸ìš©)
  "íì‰í¬ë°•ìŠ¤": { detail: "EPSON í”„ë¦°í„° ì „ìš© íì‰í¬ë°•ìŠ¤", price: 41000, stock: "ì¬ê³ ìˆìŒ" }
};

let productCount = 0;
const maxProducts = 8;

// ì œí’ˆ ì¹´ìš´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProductCounter() {
  const counter = document.getElementById('product-counter');
  if (counter) {
    counter.textContent = `${productCount} / ${maxProducts}`;
    counter.style.background = productCount >= maxProducts ? '#e74c3c' : '#1cc7b6';
  }
}

// í–¥ìƒëœ ì œí’ˆ ì„¸íŠ¸ ìƒì„± í•¨ìˆ˜
function createProductSet(idx) {
  const typeOptions = [
    '<option value="">êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>',
    '<option value="ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°">ğŸ–¨ï¸ ì»¬ëŸ¬ë¼ë²¨í”„ë¦°í„°</option>',
    '<option value="ë””ì§€í„¸íŒ¨í‚¤ì§•ì¥ë¹„">ğŸ“¦ ë””ì§€í„¸íŒ¨í‚¤ì§•ì¥ë¹„</option>',
    '<option value="ë°”ì½”ë“œë¼ë²¨í”„ë¦°í„°">ğŸ·ï¸ ë°”ì½”ë“œë¼ë²¨í”„ë¦°í„°</option>',
    '<option value="íŠ¹ìˆ˜ì¥ë¹„">ğŸ”¬ íŠ¹ìˆ˜ì¥ë¹„</option>',
    '<option value="ì†Œëª¨í’ˆ">ğŸ”§ ì†Œëª¨í’ˆ</option>'
  ].join('');
  
  return `
  <div class="product-set fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <span style="font-weight: bold; color: #2c3e50;">ğŸ“¦ ì œí’ˆ ${idx+1}</span>
      ${idx > 0 ? '<button type="button" onclick="removeProduct(this)" class="remove-btn">ğŸ—‘ï¸ ì‚­ì œ</button>' : ''}
    </div>
    <div class="product-row">
      <select class="product-type" style="flex: 2;">
        ${typeOptions}
      </select>
      <select class="product-name" style="flex: 3;">
        <option value="">ì œí’ˆëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
      </select>
    </div>
    <input class="product-detail" type="text" placeholder="ğŸ“ ì œí’ˆ ìƒì„¸ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤" readonly style="background: #f8f9fa;">
    <div class="product-row">
      <input class="product-qty" type="number" min="1" placeholder="ğŸ“Š ìˆ˜ëŸ‰" style="flex: 1;">
      <input class="product-price" type="number" min="0" placeholder="ğŸ’° ê³µê¸‰ë‹¨ê°€(ì›)" style="flex: 2;">
    </div>
    <input class="product-total" type="text" placeholder="ğŸ’µ í•©ê³„ (VATë³„ë„)" readonly style="background: #f8f9fa; font-weight: bold;">
    <input class="product-note" type="text" maxlength="50" placeholder="ğŸ“ ë¹„ê³ ì‚¬í•­ (50ìê¹Œì§€ ì…ë ¥ê°€ëŠ¥)">
    <div class="stock-info" style="font-size: 0.8em; color: #666; margin-top: 4px; display: none;">
      <span class="stock-status"></span>
    </div>
  </div>
  `;
}

// í–¥ìƒëœ ì œí’ˆëª… ì˜µì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProductNameOptions(typeSelect, nameSelect, consumableSelect) {
  const type = typeSelect.value;
  nameSelect.innerHTML = '<option value="">ì œí’ˆëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
  
  // ì¬ê³  ì •ë³´ í‘œì‹œ ì˜ì—­
  const stockInfo = typeSelect.closest('.product-set').querySelector('.stock-info');
  stockInfo.style.display = 'none';

  // ì†Œëª¨í’ˆì¼ ë•Œ
  if(type === "ì†Œëª¨í’ˆ") {
    // ì†Œëª¨í’ˆ ëª¨ë¸ ë“œë¡­ë‹¤ìš´ì´ ì—†ìœ¼ë©´ ì¶”ê°€
    if(!consumableSelect) {
      consumableSelect = document.createElement('select');
      consumableSelect.className = 'consumable-model';
      consumableSelect.style.flex = '2';
      consumableSelect.innerHTML = '<option value="">ğŸ”§ ì†Œëª¨í’ˆ ëª¨ë¸ ì„ íƒ</option>' +
        consumableModelList.map(m => `<option value="${m}">${m}</option>`).join('');
      typeSelect.parentNode.insertBefore(consumableSelect, nameSelect);
      
      consumableSelect.addEventListener('change', function() {
        updateProductNameOptions(typeSelect, nameSelect, consumableSelect);
      });
    }
    
    // ëª¨ë¸ ì„ íƒ ì‹œ ì œí’ˆëª… ì˜µì…˜ ë³€ê²½
    const selectedModel = consumableSelect.value;
    if(consumableProducts[selectedModel]) {
      consumableProducts[selectedModel].forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        nameSelect.appendChild(opt);
      });
    }
  } else {
    // ì†Œëª¨í’ˆì´ ì•„ë‹ˆë©´ ê¸°ì¡´ ë°©ì‹
    if(consumableSelect) consumableSelect.remove();
    
    if(productData[type]) {
      const items = productData[type];
      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        opt.textContent = `${item.name} ${item.category ? `(${item.category})` : ''}`;
        nameSelect.appendChild(opt);
      });
    }
  }
  
  // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
  nameSelect.style.transform = 'scale(0.95)';
  setTimeout(() => {
    nameSelect.style.transform = 'scale(1)';
  }, 100);
}

// í–¥ìƒëœ ì œí’ˆ ìƒì„¸ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProductDetail(typeSelect, nameSelect, detailInput, priceInput) {
  const type = typeSelect.value;
  const name = nameSelect.value;
  const stockInfo = typeSelect.closest('.product-set').querySelector('.stock-info');
  const stockStatus = stockInfo.querySelector('.stock-status');
  
  // ì†Œëª¨í’ˆì¼ ë•ŒëŠ” ë³„ë„ ì²˜ë¦¬
  if(type === "ì†Œëª¨í’ˆ") {
    if(consumableProductDetails[name]) {
      const item = consumableProductDetails[name];
      detailInput.value = item.detail;
      priceInput.value = item.price;
      
      // ì¬ê³  ì •ë³´ í‘œì‹œ
      if(item.stock) {
        stockStatus.textContent = `ğŸ“¦ ì¬ê³ ìƒíƒœ: ${item.stock}`;
        stockStatus.style.color = item.stock === "ì¬ê³ ìˆìŒ" ? "#27ae60" : "#e67e22";
        stockInfo.style.display = 'block';
      }
    } else {
      detailInput.value = '';
      priceInput.value = '';
      stockInfo.style.display = 'none';
    }
    return;
  }
  
  if(productData[type]) {
    const found = productData[type].find(item => item.name === name);
    if(found) {
      detailInput.value = found.detail;
      priceInput.value = found.price;
      
      // ì¹´í…Œê³ ë¦¬ ì •ë³´ í‘œì‹œ
      if(found.category) {
        stockStatus.textContent = `ğŸ·ï¸ ë¶„ë¥˜: ${found.category}`;
        stockStatus.style.color = "#3498db";
        stockInfo.style.display = 'block';
      }
      
      // ê°€ê²©ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
      if(found.price >= 10000000) {
        priceInput.style.color = "#e74c3c"; // 1ì²œë§Œì› ì´ìƒ ë¹¨ê°„ìƒ‰
      } else if(found.price >= 5000000) {
        priceInput.style.color = "#f39c12"; // 500ë§Œì› ì´ìƒ ì£¼í™©ìƒ‰
      } else {
        priceInput.style.color = "#27ae60"; // ê·¸ ì™¸ ë…¹ìƒ‰
      }
    } else {
      detailInput.value = '';
      priceInput.value = '';
      stockInfo.style.display = 'none';
    }
  }
  
  // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
  detailInput.style.background = '#e8f5e8';
  setTimeout(() => {
    detailInput.style.background = '#f8f9fa';
  }, 500);
}

// í–¥ìƒëœ ì œí’ˆ í•©ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProductTotal(qtyInput, priceInput, totalInput) {
  const qty = Number(qtyInput.value);
  const price = Number(priceInput.value);
  
  if(qty && price) {
    const total = qty * price;
    totalInput.value = total.toLocaleString() + 'ì›';
    
    // í•©ê³„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    if(total >= 50000000) {
      totalInput.style.color = "#e74c3c";
      totalInput.style.fontWeight = "bold";
    } else if(total >= 10000000) {
      totalInput.style.color = "#f39c12"; 
      totalInput.style.fontWeight = "bold";
    } else {
      totalInput.style.color = "#27ae60";
      totalInput.style.fontWeight = "normal";
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    totalInput.style.transform = 'scale(1.05)';
    setTimeout(() => {
      totalInput.style.transform = 'scale(1)';
    }, 200);
  } else {
    totalInput.value = '';
    totalInput.style.color = "";
    totalInput.style.fontWeight = "normal";
  }
}

// í–¥ìƒëœ ì œí’ˆ ì œê±° í•¨ìˆ˜
function removeProduct(btn) {
  const productSet = btn.closest('.product-set');
  
  // ì œê±° ì• ë‹ˆë©”ì´ì…˜
  productSet.style.transition = 'all 0.3s ease';
  productSet.style.transform = 'scale(0.9)';
  productSet.style.opacity = '0';
  
  setTimeout(() => {
    productSet.remove();
    productCount--;
    updateProductCounter();
    document.getElementById('add-product').disabled = false;
    
    // ì œí’ˆ ë²ˆí˜¸ ë‹¤ì‹œ ë§¤ê¸°ê¸°
    document.querySelectorAll('.product-set').forEach((el, idx) => {
      const header = el.querySelector('div');
      const removeBtn = idx > 0 ? '<button type="button" onclick="removeProduct(this)" class="remove-btn">ğŸ—‘ï¸ ì‚­ì œ</button>' : '';
      header.innerHTML = `<span style="font-weight: bold; color: #2c3e50;">ğŸ“¦ ì œí’ˆ ${idx+1}</span>${removeBtn}`;
    });
  }, 300);
}

// í–¥ìƒëœ ì œí’ˆ ì„¸íŠ¸ ì¶”ê°€ í•¨ìˆ˜
function addProductSet() {
  if(productCount >= maxProducts) {
    alert(`ìµœëŒ€ ${maxProducts}ê°œ ì œí’ˆê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    return;
  }
  
  const area = document.getElementById('products-area');
  area.insertAdjacentHTML('beforeend', createProductSet(productCount));
  productCount++;
  updateProductCounter();
  
  if(productCount >= maxProducts) {
    document.getElementById('add-product').disabled = true;
    document.getElementById('add-product').textContent = 'â• ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬';
  }
  
  // ìƒˆë¡œ ì¶”ê°€ëœ ì œí’ˆ ì„¸íŠ¸ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
  const sets = area.querySelectorAll('.product-set');
  const lastSet = sets[sets.length-1];
  const typeSelect = lastSet.querySelector('.product-type');
  const nameSelect = lastSet.querySelector('.product-name');
  const detailInput = lastSet.querySelector('.product-detail');
  const qtyInput = lastSet.querySelector('.product-qty');
  const priceInput = lastSet.querySelector('.product-price');
  const totalInput = lastSet.querySelector('.product-total');
  const noteInput = lastSet.querySelector('.product-note');

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  typeSelect.addEventListener('change', () => {
    updateProductNameOptions(typeSelect, nameSelect, typeSelect.parentNode.querySelector('.consumable-model'));
    detailInput.value = '';
    priceInput.value = '';
    nameSelect.value = '';
    totalInput.value = '';
    priceInput.style.color = '';
    totalInput.style.color = '';
  });
  
  nameSelect.addEventListener('change', () => {
    updateProductDetail(typeSelect, nameSelect, detailInput, priceInput);
    updateProductTotal(qtyInput, priceInput, totalInput);
  });
  
  qtyInput.addEventListener('input', () => updateProductTotal(qtyInput, priceInput, totalInput));
  priceInput.addEventListener('input', () => updateProductTotal(qtyInput, priceInput, totalInput));
  
  noteInput.addEventListener('input', () => { 
    if(noteInput.value.length > 50) {
      noteInput.value = noteInput.value.slice(0, 50);
      noteInput.style.borderColor = '#e74c3c';
      setTimeout(() => {
        noteInput.style.borderColor = '';
      }, 1000);
    }
  });
  
  // ìƒˆë¡œ ì¶”ê°€ëœ ì œí’ˆì— í¬ì»¤ìŠ¤
  typeSelect.focus();
}

// ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('add-product').addEventListener('click', addProductSet);

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ì œí’ˆ ì„¸íŠ¸ ì¶”ê°€
addProductSet();

// í™•ì¥ëœ ë‹´ë‹¹ì-ì—°ë½ì²˜ ë§¤í•‘
const supplierContacts = {
  "ì´í›ˆìˆ˜": { contact: "hslee@bitekps.com / 010-3252-0593", department: "ì˜ì—…íŒ€", position: "ì´ì‚¬" },
  "ì°¨ì¬ì›": { contact: "cjw@bitekps.com / 010-5035-7791", department: "ì˜ì—…íŒ€", position: "ì°¨ì¥" },
  "ì¥ì§„í˜¸": { contact: "jhjang@bitekps.com / 010-9999-4401", department: "ê¸°ìˆ íŒ€", position: "ëŒ€ë¦¬" },
  "í•˜ì² ìš©": { contact: "cyha@bitekps.com / 010-6206-7656", department: "ì˜ì—…íŒ€", position: "ì°¨ì¥" },
  "ë…¸ì¬ìµ": { contact: "jake@bitekps.com / 010-6419-0945", department: "í•´ì™¸ì˜ì—…íŒ€", position: "ì°¨ì¥" },
  "ì „ì¤€ì˜": { contact: "methu78@bitekps.com / 010-2866-4914", department: "ê¸°ìˆ ì§€ì›íŒ€", position: "ê³¼ì¥" }
};

// í–¥ìƒëœ ë‹´ë‹¹ì ì„ íƒ ì´ë²¤íŠ¸
document.getElementById('supplier-person').addEventListener('change', function() {
  const selected = this.options[this.selectedIndex];
  const contactInput = document.getElementById('supplier-contact');
  const idInput = document.getElementById('supplier-person-id');
  
  // ì—°ë½ì²˜ ìë™ í‘œì‹œ
  contactInput.value = selected.getAttribute('data-contact') || '';
  
  // ë‹´ë‹¹ìID ìë™ í‘œì‹œ
  idInput.value = selected.getAttribute('data-id') || '';
  
  // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
  contactInput.style.background = '#e8f5e8';
  idInput.style.background = '#e8f5e8';
  
  setTimeout(() => {
    contactInput.style.background = '#f8f9fa';
    idInput.style.background = '#f8f9fa';
  }, 500);
});

// í–¥ìƒëœ ê²¬ì ë²ˆí˜¸ ìë™ìƒì„± í•¨ìˆ˜
async function autoFillEstimateNumber() {
  const dateVal = document.getElementById('date').value;
  const supplierSelect = document.getElementById('supplier-person');
  const supplierId = supplierSelect.options[supplierSelect.selectedIndex]?.getAttribute('data-id') || '';
  const numberInput = document.getElementById('number');
  
  if (!dateVal || !supplierId) return;

  // ë‚ ì§œ YYMMDD ë³€í™˜
  const yymmdd = dateVal.replace(/-/g, '').slice(2);

  // ë¡œë”© í‘œì‹œ
  numberInput.style.background = '#fff3cd';
  numberInput.value = 'ìƒì„± ì¤‘...';

  // ì˜¤ëŠ˜ PDFìƒì„±íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°
  let count = 1;
  try {
    const res = await fetch('https://auto-estimate.onrender.com/estimate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ check_only: true })
    });
    const result = await res.json();
    if (result.pdf_count_today) count = result.pdf_count_today + 1;
  } catch (e) {
    console.warn('ê²¬ì ë²ˆí˜¸ ìë™ìƒì„± ì¤‘ ì˜¤ë¥˜:', e);
  }

  const estimateNumber = `DLP${yymmdd}-${supplierId}-${count}`;
  
  // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ë²ˆí˜¸ í‘œì‹œ
  setTimeout(() => {
    numberInput.value = estimateNumber;
    numberInput.style.background = '#d4edda';
    
    setTimeout(() => {
      numberInput.style.background = '';
    }, 1000);
  }, 500);
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.getElementById('date').addEventListener('change', autoFillEstimateNumber);
document.getElementById('supplier-person').addEventListener('change', autoFillEstimateNumber);

// ENHANCED TEST ë²„ì „ - ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (í™•ì¥ë¨)
function collectEstimateData() {
  const fileId = new URLSearchParams(window.location.search).get("id");
  const majorCategoryElement = document.querySelector('.product-major-category');
  
  console.log("=== ENHANCED TEST ë²„ì „ ë°ì´í„° ìˆ˜ì§‘ ===");
  console.log("major_category ìš”ì†Œ:", majorCategoryElement);
  console.log("major_category ê°’:", majorCategoryElement ? majorCategoryElement.value : 'null');
  
  // ì œí’ˆ ë°ì´í„° ìˆ˜ì§‘ (í–¥ìƒëœ ë²„ì „)
  const products = Array.from(document.querySelectorAll('.product-set')).map(function(set) {
    const type = set.querySelector('.product-type').value;
    const name = set.querySelector('.product-name').value;
    const detail = set.querySelector('.product-detail').value;
    const qty = Number(set.querySelector('.product-qty').value);
    const priceStr = set.querySelector('.product-price').value;
    const totalStr = set.querySelector('.product-total').value;
    const note = set.querySelector('.product-note').value;
    
    return {
      type: type,
      name: name,
      detail: detail,
      qty: qty,
      price: Number(priceStr.toString().replace(/[^0-9]/g, '')),
      total: Number(totalStr.toString().replace(/[^0-9]/g, '')),
      note: note,
      // ENHANCED ë²„ì „ ì¶”ê°€ ì •ë³´
      timestamp: new Date().toISOString(),
      validation: {
        hasType: !!type,
        hasName: !!name,
        hasQty: qty > 0,
        hasPrice: Number(priceStr) > 0
      }
    };
  });
  
  return {
    // ê¸°ë³¸ ì •ë³´
    estimate_date: document.getElementById('date').value,
    estimate_number: document.getElementById('number').value,
    supplier_person: document.getElementById('supplier-person').options[document.getElementById('supplier-person').selectedIndex]?.text || '',
    supplier_contact: document.getElementById('supplier-contact').value,
    receiver_company: document.getElementById('receiver-company').value,
    receiver_person: document.getElementById('receiver-person').value,
    receiver_contact: document.getElementById('receiver-contact').value,
    delivery_date: document.getElementById('delivery-date').value,
    fileId: fileId,
    
    // TEST ë²„ì „ í•µì‹¬ ê¸°ëŠ¥
    major_category: majorCategoryElement ? majorCategoryElement.value : '',
    product_category: document.getElementById('product-category').value,
    
    // ì œí’ˆ ì •ë³´
    products: products,
    
    // ENHANCED ë²„ì „ ì¶”ê°€ ì •ë³´
    metadata: {
      version: "ENHANCED_TEST_v1.0",
      productCount: products.length,
      totalAmount: products.reduce((sum, p) => sum + (p.total || 0), 0),
      createdAt: new Date().toISOString(),
      userAgent: navigator.userAgent,
      screenResolution: `${screen.width}x${screen.height}`,
      validationStatus: {
        allProductsValid: products.every(p => p.validation.hasType && p.validation.hasName && p.validation.hasQty && p.validation.hasPrice),
        productValidationDetails: products.map(p => p.validation)
      }
    }
  };
}

// ENHANCED TEST ë²„ì „ - í–¥ìƒëœ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
function validateEstimateForm() {
  console.log("=== ENHANCED TEST ë²„ì „ ê²¬ì ì„œ ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘ ===");
  
  const validationResults = {
    passed: true,
    errors: [],
    warnings: []
  };
  
  // í•„ìˆ˜ ì…ë ¥ê°’ ì²´í¬
  const date = document.getElementById('date').value;
  const number = document.getElementById('number').value;
  const supplierPerson = document.getElementById('supplier-person').value;
  const receiverCompany = document.getElementById('receiver-company').value;
  const productCategory = document.getElementById('product-category').value;
  const majorCategory = document.getElementById('major-category').value;
  const deliveryDate = document.getElementById('delivery-date').value;
  
  console.log("ENHANCED TEST ë²„ì „ ì…ë ¥ê°’ í™•ì¸:");
  console.log("- ê²¬ì ì¼ì:", date);
  console.log("- ê²¬ì ë²ˆí˜¸:", number);
  console.log("- ê³µê¸‰ì ë‹´ë‹¹ì:", supplierPerson);
  console.log("- ìˆ˜ì‹ ì íšŒì‚¬ëª…:", receiverCompany);
  console.log("- ê²¬ì ì œí’ˆ:", productCategory);
  console.log("- ğŸ†• ì œí’ˆ ëŒ€ë¶„ë¥˜:", majorCategory);
  console.log("- ë‚©ê¸°ì¼:", deliveryDate);
  
  // ê°œë³„ í•„ë“œ ê²€ì¦
  if (!date) {
    validationResults.errors.push('ê²¬ì ì¼ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  } else {
    const selectedDate = new Date(date);
    const today = new Date();
    if (selectedDate < today.setHours(0,0,0,0)) {
      validationResults.warnings.push('ê²¬ì ì¼ìê°€ ê³¼ê±° ë‚ ì§œì…ë‹ˆë‹¤.');
    }
  }
  
  if (!number) {
    validationResults.errors.push('ê²¬ì ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  } else if (!/^DLP\d{6}-[A-F]-\d+$/.test(number)) {
    validationResults.warnings.push('ê²¬ì ë²ˆí˜¸ í˜•ì‹ì´ í‘œì¤€ê³¼ ë‹¤ë¦…ë‹ˆë‹¤. (ê¶Œì¥: DLP******-*-*)');
  }
  
  if (!supplierPerson) {
    validationResults.errors.push('ê³µê¸‰ì ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
  }
  
  if (!receiverCompany) {
    validationResults.errors.push('ìˆ˜ì‹ ì íšŒì‚¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  }
  
  if (!productCategory) {
    validationResults.errors.push('ê²¬ì ì œí’ˆì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
  }
  
  // ENHANCED TEST ë²„ì „ í•µì‹¬ ê²€ì¦: ì œí’ˆ ëŒ€ë¶„ë¥˜ í•„ìˆ˜
  if (!majorCategory) {
    validationResults.errors.push('ğŸ†• ì œí’ˆ ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.\n(ì´ ê¸°ëŠ¥ì€ ENHANCED TEST ë²„ì „ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤)');
  }
  
  if (!deliveryDate) {
    validationResults.errors.push('ë‚©ê¸°ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  }
  
  // ì œí’ˆì •ë³´ ê³ ê¸‰ ê²€ì¦
  const sets = document.querySelectorAll('.product-set');
  if (sets.length === 0) {
    validationResults.errors.push('ì œí’ˆì •ë³´ë¥¼ 1ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  }
  
  let totalAmount = 0;
  let hasHighValueProduct = false;
  
  for (let i = 0; i < sets.length; i++) {
    const set = sets[i];
    const type = set.querySelector('.product-type').value;
    const name = set.querySelector('.product-name').value;
    const detail = set.querySelector('.product-detail').value;
    const qty = set.querySelector('.product-qty').value;
    const price = set.querySelector('.product-price').value;
    const total = set.querySelector('.product-total').value;
    
    const productErrors = [];
    
    if (!type) productErrors.push(`ì œí’ˆ ${i+1}: êµ¬ë¶„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.`);
    if (!name) productErrors.push(`ì œí’ˆ ${i+1}: ì œí’ˆëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.`);
    if (!detail) productErrors.push(`ì œí’ˆ ${i+1}: ìƒì„¸ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
    if (!qty || qty <= 0) productErrors.push(`ì œí’ˆ ${i+1}: ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
    if (!price || price <= 0) productErrors.push(`ì œí’ˆ ${i+1}: ì˜¬ë°”ë¥¸ ê³µê¸‰ë‹¨ê°€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
    if (!total) productErrors.push(`ì œí’ˆ ${i+1}: í•©ê³„ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
    
    validationResults.errors.push(...productErrors);
    
    // ê³ ê¸‰ ê²€ì¦
    if (price && qty) {
      const productTotal = Number(price) * Number(qty);
      totalAmount += productTotal;
      
      if (productTotal >= 10000000) {
        hasHighValueProduct = true;
        validationResults.warnings.push(`ì œí’ˆ ${i+1}: ê³ ì•¡ ì œí’ˆì…ë‹ˆë‹¤. (${productTotal.toLocaleString()}ì›)`);
      }
    }
  }
  
  // ì „ì²´ ê²¬ì  ê¸ˆì•¡ ê²€ì¦
  if (totalAmount >= 100000000) {
    validationResults.warnings.push(`ì „ì²´ ê²¬ì ê¸ˆì•¡ì´ ê³ ì•¡ì…ë‹ˆë‹¤. (${totalAmount.toLocaleString()}ì›) ìŠ¹ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
  }
  
  // ê²°ê³¼ ì²˜ë¦¬
  validationResults.passed = validationResults.errors.length === 0;
  
  if (validationResults.errors.length > 0) {
    console.log("âŒ ENHANCED TEST ë²„ì „ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨");
    console.log("ì˜¤ë¥˜ëª©ë¡:", validationResults.errors);
    alert('ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”:\n\n' + validationResults.errors.join('\n'));
    return false;
  }
  
  if (validationResults.warnings.length > 0) {
    console.log("âš ï¸ ENHANCED TEST ë²„ì „ ìœ íš¨ì„± ê²€ì‚¬ ê²½ê³ ");
    console.log("ê²½ê³ ëª©ë¡:", validationResults.warnings);
    const confirmMessage = 'ë‹¤ìŒ ê²½ê³ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤:\n\n' + 
                          validationResults.warnings.join('\n') + 
                          '\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    if (!confirm(confirmMessage)) {
      return false;
    }
  }
  
  console.log("âœ… ENHANCED TEST ë²„ì „ ëª¨ë“  í•„ìˆ˜ ì…ë ¥ê°’ ê²€ì¦ ì™„ë£Œ");
  console.log("ê²¬ì  ìš”ì•½:", {
    ì œí’ˆìˆ˜: sets.length,
    ì´ê²¬ì ê¸ˆì•¡: totalAmount.toLocaleString() + 'ì›',
    ê³ ì•¡ì œí’ˆì—¬ë¶€: hasHighValueProduct,
    ëŒ€ë¶„ë¥˜: majorCategory
  });
  
  return true;
}

// ENHANCED TEST ë²„ì „ - ê²¬ì ì„œ ì „ì†¡ í•¨ìˆ˜ (í–¥ìƒëœ ê¸°ëŠ¥)
async function sendEstimateToFastAPI() {
  console.log("=== ENHANCED TEST ë²„ì „ ê²¬ì ì„œ ìƒì„± ì‹œì‘ ===");
  
  if (!validateEstimateForm()) {
    console.log("âŒ ENHANCED TEST ë²„ì „ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨");
    return;
  }
  
  console.log("âœ… ENHANCED TEST ë²„ì „ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼");
  
  const button = document.getElementById('preview-btn');
  const originalText = button.textContent;
  
  try {
    // í–¥ìƒëœ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
    button.disabled = true;
    button.classList.add('loading');
    button.textContent = 'ğŸ”„ ENHANCED TEST ì²˜ë¦¬ ì¤‘...';
    
    // í”„ë¡œê·¸ë˜ìŠ¤ ë°” ì‹œë®¬ë ˆì´ì…˜
    const progressSteps = [
      'ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ì¤‘...',
      'ğŸ” ìœ íš¨ì„± ì¬ê²€ì¦ ì¤‘...',
      'ğŸ“„ í…œí”Œë¦¿ ì¤€ë¹„ ì¤‘...',
      'ğŸš€ ê²¬ì ì„œ ìƒì„± ì¤‘...',
      'âœ¨ ìµœì¢… ì²˜ë¦¬ ì¤‘...'
    ];
    
    let stepIndex = 0;
    const progressInterval = setInterval(() => {
      if (stepIndex < progressSteps.length) {
        button.textContent = progressSteps[stepIndex];
        stepIndex++;
      }
    }, 800);
    
    const data = collectEstimateData();
    let fileId = new URLSearchParams(window.location.search).get("id");
    
    console.log("ENHANCED TEST ë²„ì „ ìˆ˜ì§‘ëœ ë°ì´í„°:", data);
    console.log("ë©”íƒ€ë°ì´í„°:", data.metadata);
    console.log("ìœ íš¨ì„± ê²€ì‚¬ ìƒíƒœ:", data.metadata.validationStatus);
    
    // fileId ì²˜ë¦¬ (í–¥ìƒëœ ë¡œì§)
    if (!fileId || fileId === "{{24.id}}" || fileId.includes("{{") || fileId.includes("}}")) {
      console.log("ENHANCED TEST ë²„ì „: ìƒˆë¡œìš´ í…œí”Œë¦¿ ìƒì„± í•„ìš”");
      
      try {
        console.log("ENHANCED TEST ë²„ì „: ê²¬ì ì„œ í…œí”Œë¦¿ ìƒì„± API í˜¸ì¶œ...");
        
        const templateResponse = await fetch('https://auto-estimate.onrender.com/create-estimate-template', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Client-Version': 'ENHANCED_TEST_v1.0'
          }
        });
        
        const templateResult = await templateResponse.json();
        
        if (templateResult.status === "success") {
          console.log("ENHANCED TEST ë²„ì „: í…œí”Œë¦¿ ìƒì„± ì„±ê³µ");
          fileId = templateResult.file_id;
          data.fileId = fileId;
          
          // URL ì—…ë°ì´íŠ¸
          const newUrl = new URL(window.location);
          newUrl.searchParams.set('id', fileId);
          window.history.replaceState({}, '', newUrl);
        } else {
          throw new Error(templateResult.message || 'í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error("ENHANCED TEST ë²„ì „: í…œí”Œë¦¿ ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
        clearInterval(progressInterval);
        alert("í…œí”Œë¦¿ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        return;
      }
    } else {
      console.log("ENHANCED TEST ë²„ì „: ê¸°ì¡´ fileId ì‚¬ìš©:", fileId);
      data.fileId = fileId;
    }

    // ê²¬ì ì œí’ˆ ì„ íƒ ê°’ ì €ì¥ (í–¥ìƒëœ ë²„ì „)
    const productCategory = document.getElementById('product-category').value;
    const majorCategory = document.getElementById('major-category').value;
    
    localStorage.setItem('productCategory', productCategory);
    localStorage.setItem('majorCategory', majorCategory); // ENHANCED ê¸°ëŠ¥
    localStorage.setItem('enhancedTestData', JSON.stringify({
      version: 'ENHANCED_TEST_v1.0',
      timestamp: new Date().toISOString(),
      productCount: data.products.length,
      totalAmount: data.metadata.totalAmount
    }));

    // ìµœì†Œ ë¡œë”© ì‹œê°„ (í–¥ìƒëœ ì‚¬ìš©ì ê²½í—˜)
    const startTime = Date.now();
    const minLoadingTime = 2000; // 2ì´ˆ
    
    console.log("ENHANCED TEST ë²„ì „: ê²¬ì ì„œ ìƒì„± API í˜¸ì¶œ");
    
    const response = await fetch('https://auto-estimate.onrender.com/estimate', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-Client-Version': 'ENHANCED_TEST_v1.0',
        'X-Product-Count': data.products.length.toString(),
        'X-Major-Category': majorCategory
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    console.log("ENHANCED TEST ë²„ì „: API ì‘ë‹µ:", result);
    
    clearInterval(progressInterval);
    button.textContent = 'ğŸ‰ ì™„ë£Œ ì¤€ë¹„ ì¤‘...';
    
    if(result.status === "success") {
      // ìµœì†Œ ë¡œë”© ì‹œê°„ ë³´ì¥
      const elapsedTime = Date.now() - startTime;
      const remainingTime = Math.max(0, minLoadingTime - elapsedTime);
      
      setTimeout(() => {
        // localStorageì— ë°ì´í„° ì €ì¥
        const dataToStore = JSON.stringify(data);
        localStorage.setItem('estimateData', dataToStore);
        
        console.log('ENHANCED TEST ë²„ì „: ë°ì´í„° ì €ì¥ ì™„ë£Œ');
        console.log('preview.htmlë¡œ ì´ë™ (fileId:', fileId, ')');
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        const successMsg = `âœ… ê²¬ì ì„œ ìƒì„± ì™„ë£Œ!\n` +
                          `ğŸ“Š ì œí’ˆ ìˆ˜: ${data.products.length}ê°œ\n` +
                          `ğŸ’° ì´ ê¸ˆì•¡: ${data.metadata.totalAmount.toLocaleString()}ì›\n` +
                          `ğŸ·ï¸ ëŒ€ë¶„ë¥˜: ${majorCategory}`;
        
        // ì ì‹œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ì´ë™
        button.textContent = 'âœ… ìƒì„± ì™„ë£Œ!';
        button.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
        
        setTimeout(() => {
          if (fileId) {
            window.location.href = `preview.html?id=${fileId}&enhanced=true`;
          } else {
            window.location.href = `preview.html?enhanced=true`;
          }
        }, 1000);
        
      }, remainingTime);
    } else {
      clearInterval(progressInterval);
      alert('âŒ ENHANCED TEST ë²„ì „: ì „ì†¡ ì‹¤íŒ¨!\n' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
    }
  } catch (error) {
    console.error('ENHANCED TEST ë²„ì „: ê²¬ì ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
    alert('âŒ ENHANCED TEST ë²„ì „: ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
  } finally {
    // ë²„íŠ¼ ìƒíƒœ ë³µì›
    button.disabled = false;
    button.classList.remove('loading');
    button.textContent = originalText;
    button.style.background = '';
  }
}

// ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('preview-btn').addEventListener('click', sendEstimateToFastAPI);

// ENHANCED TEST ë²„ì „ - í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ (í™•ì¥ëœ ê¸°ëŠ¥)
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const fileId = urlParams.get("id");
  const timestamp = urlParams.get("t");
  
  console.log("=== ENHANCED TEST ë²„ì „ í˜ì´ì§€ ë¡œë“œ ===");
  console.log("ğŸš€ ë²„ì „: ENHANCED_TEST_v1.0");
  console.log("ğŸ“… ë¡œë“œ ì‹œê°„:", new Date().toLocaleString());
  console.log("ğŸ”— URL íŒŒë¼ë¯¸í„°:", { fileId, timestamp });
  console.log("ğŸŒ ì „ì²´ URL:", window.location.href);
  
  // major_category ìš”ì†Œ í™•ì¸
  const majorCategoryElement = document.querySelector('.product-major-category');
  console.log("ğŸ·ï¸ major_category ìš”ì†Œ:", majorCategoryElement ? "âœ… ì •ìƒ ë¡œë“œë¨" : "âŒ ë¡œë“œ ì‹¤íŒ¨");
  
  if (majorCategoryElement) {
    console.log("ğŸ·ï¸ major_category ì˜µì…˜ ìˆ˜:", majorCategoryElement.options.length);
    console.log("ğŸ·ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ ëŒ€ë¶„ë¥˜:", Array.from(majorCategoryElement.options).map(o => o.value).filter(v => v));
  }
  
  // localStorage í™•ì¸
  const storageData = {
    estimateData: localStorage.getItem('estimateData'),
    productCategory: localStorage.getItem('productCategory'),
    majorCategory: localStorage.getItem('majorCategory'),
    enhancedTestData: localStorage.getItem('enhancedTestData')
  };
  
  console.log("ğŸ’¾ localStorage ìƒíƒœ:");
  Object.entries(storageData).forEach(([key, value]) => {
    if (value) {
      try {
        const parsed = JSON.parse(value);
        console.log(`- ${key}:`, parsed);
      } catch (e) {
        console.log(`- ${key}:`, value);
      }
    } else {
      console.log(`- ${key}: ì—†ìŒ`);
    }
  });
  
  // fileId ìƒíƒœ ë¶„ì„
  if (!fileId || fileId === "{{24.id}}" || fileId.includes("{{") || fileId.includes("}}")) {
    console.log("ğŸ“„ fileId: ìƒˆ í…œí”Œë¦¿ ìƒì„± í•„ìš”");
  } else {
    console.log("ğŸ“„ fileId: ê¸°ì¡´ í…œí”Œë¦¿ ì‚¬ìš© -", fileId);
  }
  
  // ë¸Œë¼ìš°ì € ì •ë³´
  console.log("ğŸŒ ë¸Œë¼ìš°ì € ì •ë³´:", {
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    cookieEnabled: navigator.cookieEnabled,
    onLine: navigator.onLine
  });
  
  // í™”ë©´ ì •ë³´
  console.log("ğŸ–¥ï¸ í™”ë©´ ì •ë³´:", {
    screen: `${screen.width}x${screen.height}`,
    window: `${window.innerWidth}x${window.innerHeight}`,
    devicePixelRatio: window.devicePixelRatio
  });
  
  // ì„±ëŠ¥ ì¸¡ì •
  if (performance.timing) {
    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
    console.log("âš¡ í˜ì´ì§€ ë¡œë“œ ì‹œê°„:", loadTime + 'ms');
  }
  
  // ì´ˆê¸° ì„¤ì •
  updateProductCounter();
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì • (ì˜µì…˜)
  const dateInput = document.getElementById('date');
  if (!dateInput.value) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    console.log("ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •:", today);
  }
  
  // ì ‘ê·¼ì„± í–¥ìƒ
  console.log("â™¿ ì ‘ê·¼ì„± ê¸°ëŠ¥ í™œì„±í™”");
  document.querySelectorAll('input, select, button').forEach(element => {
    if (!element.getAttribute('aria-label') && element.placeholder) {
      element.setAttribute('aria-label', element.placeholder);
    }
  });
  
  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
  document.addEventListener('keydown', function(e) {
    // Ctrl+Enter: ê²¬ì ì„œ ìƒì„±
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('preview-btn').click();
      console.log("âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: ê²¬ì ì„œ ìƒì„±");
    }
    
    // Ctrl+Plus: ì œí’ˆ ì¶”ê°€
    if (e.ctrlKey && e.key === '+') {
      e.preventDefault();
      document.getElementById('add-product').click();
      console.log("âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: ì œí’ˆ ì¶”ê°€");
    }
  });
  
  console.log("=== ENHANCED TEST ë²„ì „ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===");
  console.log("ğŸ’¡ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤:");
  console.log("   - Ctrl+Enter: ê²¬ì ì„œ ìƒì„±");
  console.log("   - Ctrl+Plus: ì œí’ˆ ì¶”ê°€");
});

// ì¶”ê°€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function showSuccessMessage(message) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'success-message';
  msgDiv.textContent = message;
  document.querySelector('.container').insertBefore(msgDiv, document.querySelector('h2').nextSibling);
  
  setTimeout(() => {
    msgDiv.remove();
  }, 3000);
}

function showErrorMessage(message) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'error-message';
  msgDiv.textContent = message;
  document.querySelector('.container').insertBefore(msgDiv, document.querySelector('h2').nextSibling);
  
  setTimeout(() => {
    msgDiv.remove();
  }, 5000);
}

// ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
window.addEventListener('error', function(e) {
  console.error('ENHANCED TEST ë²„ì „ ì „ì—­ ì˜¤ë¥˜:', e);
  showErrorMessage('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.');
});

// ì „ì—­ Promise ê±°ë¶€ ì²˜ë¦¬
window.addEventListener('unhandledrejection', function(e) {
  console.error('ENHANCED TEST ë²„ì „ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', e);
  e.preventDefault();
  showErrorMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
});

console.log("=== ENHANCED TEST VERSION JavaScript ë¡œë“œ ì™„ë£Œ ===");
console.log("ğŸ“ ì´ ë¼ì¸ ìˆ˜: 1026ì¤„");
console.log("ğŸ“¦ íŒŒì¼ í¬ê¸°: ì•½ 52KB");
console.log("ğŸ¯ í•µì‹¬ ê¸°ëŠ¥: ì œí’ˆ ëŒ€ë¶„ë¥˜ ì„ íƒ + í–¥ìƒëœ UI/UX");

</script>
</body>
</html>