<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>견적서 미리보기</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
background: #fff;
font-family: 'Pretendard', 'Noto Sans KR', Arial, sans-serif;
margin: 0;
}
.container {
max-width: 900px;
margin: 32px auto;
background: #fff;
padding: 32px 40px 24px 40px;
border: 1px solid #e0e0e0;
border-radius: 8px;
box-shadow: none;
}
.header-bar {
background: #21808c;
color: #fff;
padding: 24px 32px;
display: flex;
justify-content: space-between;
align-items: center;
border-radius: 8px 8px 0 0;
}
h2 {
color: #21808c;
font-size: 2.2em;
margin: 32px 0 16px 0;
font-weight: 800;
letter-spacing: -1px;
}
.section-title {
color: #21808c;
font-weight: bold;
font-size: 1.1em;
border-left: 4px solid #21808c;
padding-left: 10px;
margin: 32px 0 12px 0;
background: none;
}
hr {
border: none;
border-top: 1.5px solid #e0e0e0;
margin: 24px 0;
}
.row-flex {
display: flex;
align-items: center;
margin-bottom: 8px;
}
.row-flex label {
min-width: 90px;
color: #21808c;
font-weight: 600;
margin-right: 8px;
}
.value-box {
flex: 1;
background: #f7f7f7;
border: 1px solid #e0e0e0;
border-radius: 4px;
padding: 7px 12px;
font-size: 1em;
color: #222;
}
.product-table-wrap {
overflow-x: auto;
margin-bottom: 16px;
}
.product-table {
width: 100%;
border-collapse: collapse;
background: #fff;
font-size: 1em;
text-align: center;
}
.product-table th {
background: #21808c;
color: #fff !important;
font-weight: 700;
padding: 8px 0;
border: 1px solid #e0e0e0;
}
.product-table td {
border: 1px solid #e0e0e0;
padding: 8px 0;
color: #222;
}
.final-total {
background: #21808c;
color: #fff;
font-weight: bold;
font-size: 1.1em;
}
button {
border: none;
border-radius: 6px;
padding: 12px 24px;
font-size: 1em;
margin: 0 8px;
background: #21808c;
color: #fff;
cursor: pointer;
transition: all 0.3s ease;
}

/* 로딩 애니메이션 스타일 */
.loading {
  position: relative;
  background: #1cc7b6 !important;
  color: transparent !important;
  pointer-events: none;
  transform: scale(0.98);
  box-shadow: 0 2px 8px rgba(28, 199, 182, 0.3);
  transition: all 0.3s ease;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 24px;
  margin: -12px 0 0 -12px;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top: 3px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 10;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 버튼 비활성화 상태 */
button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
button#back-to-edit {
background: #e0e0e0;
color: #21808c;
}
button:hover:not(:disabled) {
opacity: 0.9;
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(33, 128, 140, 0.3);
}

button:active:not(:disabled) {
transform: translateY(0);
box-shadow: 0 2px 6px rgba(33, 128, 140, 0.3);
}
.header-bar h2 {
color: #fff !important;
margin: 0;
font-size: 2.2em;
font-weight: 800;
letter-spacing: -1px;
}
</style>
</head>
<body>
<div class="container">
<div class="header-bar">
<h2>견적서 미리보기</h2>
</div>
<div class="section-title">기본정보</div>
<div class="row-flex">
<label>견적일자</label>
<div class="value-box" id="estimate-date"></div>
</div>
<div class="row-flex">
<label>견적번호</label>
<div class="value-box" id="estimate-number"></div>
</div>
<div class="section-title">공급자</div>
<div class="row-flex">
<label>회사명</label>
<div class="value-box" id="supplier-company"></div>
</div>
<div class="row-flex">
<label>담당자</label>
<div class="value-box" id="supplier-person"></div>
</div>
<div class="row-flex">
<label>연락처</label>
<div class="value-box" id="supplier-contact"></div>
</div>
<div class="section-title">수신자</div>
<div class="row-flex">
<label>회사명</label>
<div class="value-box" id="receiver-company"></div>
</div>
<div class="row-flex">
<label>담당자</label>
<div class="value-box" id="receiver-person"></div>
</div>
<div class="row-flex">
<label>연락처</label>
<div class="value-box" id="receiver-contact"></div>
</div>
<div class="section-title">제품정보</div>
<div class="product-table-wrap">
<table class="product-table" id="product-table">
<thead>
<tr>
<th>구분</th><th>제품명</th><th>제품상세정보</th><th>수량</th><th>공급단가(원)</th><th>합계(원)</th><th>비고</th>
</tr>
</thead>
<tbody>
<!-- JS로 제품정보 행 추가 -->
</tbody>
</table>
</div>
<div class="section-title">합계/기타</div>
<div class="row-flex">
<label>납기일</label>
<div class="value-box" id="delivery-date"></div>
</div>
<div class="row-flex">
<label>합계</label>
<div class="value-box" id="sum-total"></div>
</div>
<div class="row-flex">
<label>부가세(VAT)</label>
<div class="value-box" id="vat"></div>
</div>
<div class="row-flex">
<label>최종견적(VAT포함)</label>
<div class="value-box" id="final-total"></div>
</div>
</div>
<div style="display: flex; justify-content: center; gap: 16px; margin-top: 32px;">
<button id="back-to-edit" style="padding: 12px 24px; border-radius: 8px; border: none; background: #eee; color: #222; font-size: 1em; cursor: pointer;">편집으로 돌아가기</button>
<button id="download-pdf" style="padding: 12px 24px; border-radius: 8px; border: none; background: #1cc7b6; color: #fff; font-size: 1em; cursor: pointer;">PDF파일 생성하기</button>
</div>
<script>
// localStorage에서 데이터 읽기
const estimateData = localStorage.getItem('estimateData');
console.log('localStorage에서 읽은 데이터:', estimateData);

if (!estimateData) {
  alert('데이터가 없습니다.');
} else {
  try {
    // JSON 파싱
    const data = JSON.parse(estimateData);
    console.log('파싱된 데이터:', data);
    
    // 각 필드에 대해 안전하게 바인딩
    document.getElementById('estimate-date').textContent = data.estimate_date || '';
    document.getElementById('estimate-number').textContent = data.estimate_number || '';
    document.getElementById('supplier-company').textContent = "(주)바이텍테크놀로지";
    document.getElementById('supplier-person').textContent = (data.supplier_person || '').replace('하철웅', '하철용');
    document.getElementById('supplier-contact').textContent = data.supplier_contact || '';
    document.getElementById('receiver-company').textContent = data.receiver_company || '';
    document.getElementById('receiver-person').textContent = data.receiver_person || '';
    document.getElementById('receiver-contact').textContent = data.receiver_contact || '';
    document.getElementById('delivery-date').textContent = data.delivery_date || '';
    
    // 제품정보 테이블 생성
    const tbody = document.getElementById('product-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    if (data.products && Array.isArray(data.products)) {
      data.products.forEach(product => {
        if (product && product.type) {
          const tds = [
            `<td>${product.type || ''}</td>`,
            `<td>${product.name || ''}</td>`,
            `<td>${product.detail || ''}</td>`,
            `<td>${product.qty || ''}</td>`,
            `<td>${Number(product.price || 0).toLocaleString()}</td>`,
            `<td>${Number(product.total || 0).toLocaleString()}</td>`,
            `<td>${product.note || ''}</td>`
          ];
          tbody.innerHTML += `<tr>${tds.join('')}</tr>`;
        }
      });
    }
    
    // 합계 계산
    const total = (data.products || []).reduce((sum, p) => {
      const price = Number(p.price || 0);
      const qty = Number(p.qty || 0);
      return sum + (price * qty);
    }, 0);
    const vat = Math.round(total * 0.1);
    const finalTotal = total + vat;

    document.getElementById('sum-total').textContent = total.toLocaleString();
    document.getElementById('vat').textContent = vat.toLocaleString();
    document.getElementById('final-total').textContent = finalTotal.toLocaleString();
    
  } catch (e) {
    console.error('데이터 파싱 오류:', e);
    alert('데이터 파싱 오류가 발생했습니다. 다시 시도해 주세요.');
  }
}

// PDF 생성 함수 추가
async function generatePDF() {
  const button = document.getElementById('download-pdf');
  const originalText = button.textContent;
  
  try {
    // 버튼 비활성화 및 로딩 애니메이션 적용
    button.disabled = true;
    button.classList.add('loading');
    button.textContent = '처리 중...';
    
    // 즉시 시각적 피드백을 위한 약간의 지연
    await new Promise(resolve => setTimeout(resolve, 50));
    
    console.log('=== PDF 생성 및 전체 프로세스 시작 ===');
    
    // 최소 로딩 시간 설정 (너무 빨리 넘어가는 것 방지)
    const startTime = Date.now();
    const minLoadingTime = 2000; // 최소 2초 로딩
    
    const estimateData = localStorage.getItem('estimateData');
    if (!estimateData) {
      alert('견적 데이터가 없습니다.');
      return;
    }
    const data = JSON.parse(estimateData);

    const urlParams = new URLSearchParams(window.location.search);
    console.log('preview.html - URL 파라미터:', urlParams.toString());
    console.log('preview.html - URL에서 가져온 id:', urlParams.get('id'));
    console.log('preview.html - localStorage data.fileId:', data.fileId);
    
    const fileId = urlParams.get('id') || data.fileId;
    console.log('preview.html - 최종 사용할 fileId:', fileId);
    
    if (fileId) {
      data.fileId = fileId;
      console.log('preview.html - data.fileId 설정 완료:', data.fileId);
    } else {
      console.error('preview.html - fileId가 없습니다!');
      alert("fileId가 없습니다. URL에 id 파라미터가 필요합니다.");
      return;
    }

    // 견적제품 선택 데이터 추가 (estimate_form.html에서 전달받은 데이터)
    const productCategory = localStorage.getItem('productCategory') || '';
    data.product_category = productCategory;
    
    console.log('전송할 데이터:', data);

    // 1단계: PDF 생성 및 업로드
    console.log('1단계: PDF 생성 및 업로드 시작...');
    button.textContent = 'PDF 생성 중...';
    
    const response = await fetch('https://auto-estimate.onrender.com/collect-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    console.log('서버 응답 상태:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('서버 오류 응답:', errorText);
      throw new Error(`서버 오류: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('서버 응답:', result);
    
    button.textContent = '완료 중...';
    
    if (result.status === 'success') {
      // 최소 로딩 시간 보장
      const elapsedTime = Date.now() - startTime;
      const remainingTime = Math.max(0, minLoadingTime - elapsedTime);
      
      console.log(`성공! ${remainingTime}ms 후 페이지 이동...`);
      
      setTimeout(() => {
        // PDF 링크가 있으면 PDF 공유화면으로 이동 (원본 fileId도 함께 전달)
        if (result.pdf_link) {
          const match = result.pdf_link.match(/\/d\/([\w-]+)/);
          const pdfId = match?.[1] || '';
          const originalFileId = data.fileId; // 원본 견적서 fileId
          window.location.href = `pdf-sharing.html?id=${pdfId}&fileId=${originalFileId}`;
        } else {
          // PDF 링크가 없어도 성공 메시지 표시 후 홈으로 이동
          alert('견적 데이터가 성공적으로 처리되었습니다!\n' + result.message);
          window.location.href = 'index.html';
        }
      }, remainingTime);
    } else {
      // 실패 시에만 애니메이션 중단하고 오류 표시
      alert('PDF 생성 실패: ' + (result.message || '알 수 없는 오류'));
    }
  } catch (e) {
    console.error('PDF 생성 중 오류:', e);
    alert('PDF 생성 중 오류가 발생했습니다.\n' + e.message);
  } finally {
    // 버튼 상태 복원
    button.disabled = false;
    button.classList.remove('loading');
    button.textContent = originalText;
  }
}

document.getElementById('back-to-edit').onclick = function() {
history.back();
};

// PDF 생성 버튼에 이벤트 리스너 추가
document.getElementById('download-pdf').onclick = generatePDF;
</script>
</body>
</html>