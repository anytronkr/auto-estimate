<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>견적내용 입력</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(42, 132, 134, 0.15);
      overflow: hidden;
    }

    .header {
      background: #2A8486;
      color: white;
      padding: 30px 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #2A8486;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #2A8486;
      display: flex;
      align-items: center;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #2A8486;
      margin-right: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    label .required {
      color: #e74c3c;
      margin-left: 4px;
    }

    input[type="text"],
    input[type="date"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2A8486;
      box-shadow: 0 0 0 3px rgba(42, 132, 134, 0.1);
    }

    input[readonly] {
      background: #f8f9fa;
      cursor: not-allowed;
    }

    select {
      cursor: pointer;
      appearance: none;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
      padding-right: 40px;
    }

    hr {
      border: none;
      border-top: 1px solid #e9ecef;
      margin: 24px 0;
    }

    .product-set {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
      position: relative;
    }

    .product-set:hover {
      border-color: #2A8486;
    }

    .product-set > div:first-child {
      font-size: 16px;
      font-weight: 600;
      color: #2A8486;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .remove-btn {
      background: white;
      color: #e74c3c;
      border: 1px solid #e74c3c;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .remove-btn:hover {
      background: #e74c3c;
      color: white;
    }

    .move-btn {
      background: white;
      color: #2A8486;
      border: 1px solid #2A8486;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 30px;
    }

    .move-btn:hover {
      background: #2A8486;
      color: white;
    }

    .move-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .product-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .product-row input, .product-row select {
      flex: 1;
      margin-top: 0;
    }

    .product-field-label {
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
      display: block;
    }

    .product-field-group {
      margin-bottom: 12px;
    }

    .product-field-group.three-columns {
      display: grid;
      grid-template-columns: 1fr 1fr 1.2fr;
      gap: 12px;
    }

    .product-field-group.three-columns > div {
      display: flex;
      flex-direction: column;
    }

    /* 대분류·구분·제품명: 넓은 화면에서만 한 줄 */
    .product-field-group.product-category-row > div {
      display: flex;
      flex-direction: column;
    }

    .product-total-highlight {
      background: #e8f5f5 !important;
      border: 2px solid #2A8486 !important;
      font-weight: 700;
      font-size: 15px;
      color: #1a6b6d;
      box-shadow: 0 1px 4px rgba(42, 132, 134, 0.2);
    }

    /* 비고: 맨 마지막 줄 한 줄 최대 폭 */
    .product-field-group.product-note-row {
      width: 100%;
      margin-top: 4px;
    }
    .product-field-group.product-note-row .product-note {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* 상세정보: 제품란 전체 폭, 넓은 입력 영역 */
    .product-field-group.product-detail-row {
      width: 100%;
    }
    .product-field-group.product-detail-row .product-detail {
      width: 100%;
      max-width: 100%;
      min-height: 140px;
      box-sizing: border-box;
    }

    /* 총 견적금액 표시 */
    .summary-box {
      background: #f8f9fa;
      padding: 16px 20px;
      border-radius: 8px;
      border-left: 4px solid #2A8486;
      margin-bottom: 24px;
    }
    .summary-total {
      font-size: 18px;
      font-weight: 600;
      color: #1a6b6d;
    }
    .summary-total span:first-child {
      margin-right: 8px;
    }
    #total-estimate-amount {
      font-weight: 700;
      color: #2A8486;
    }

    .required-notice {
      background: #fff9e6;
      border-left: 4px solid #ffc107;
      padding: 12px 16px;
      margin-bottom: 24px;
      font-size: 13px;
      color: #666;
      border-radius: 4px;
    }

    .add-btn {
      background: #2A8486;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .add-btn:hover {
      background: #236b6d;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #2A8486;
      color: white;
    }

    .btn-primary:hover {
      background: #236b6d;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(42, 132, 134, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #2A8486;
      border: 1px solid #2A8486;
    }

    .btn-secondary:hover {
      background: #f8f9fa;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #e9ecef;
    }

    .info-badge {
      display: inline-block;
      background: #e8f5f5;
      color: #2A8486;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    /* 로딩 애니메이션 스타일 */
    .loading {
      position: relative;
      background: #2A8486 !important;
      color: transparent !important;
      pointer-events: none;
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(42, 132, 134, 0.3);
      transition: all 0.3s ease;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin: -12px 0 0 -12px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 버튼 비활성화 상태 */
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    textarea {
      resize: vertical;
      min-height: 150px;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .product-set > div:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .product-row {
        flex-direction: column;
        gap: 8px;
      }

      .product-field-group.three-columns {
        grid-template-columns: 1fr;
      }

      /* 대분류·구분·제품명: 좁은 화면에서는 세로 배치 */
      .product-field-group.product-category-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
    }

    /* 2-column 레이아웃 (데스크톱 1024px 이상) */
    @media (min-width: 1024px) {
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-grid > div {
        margin-bottom: 0 !important;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* 대분류·구분·제품명 한 줄 */
      .product-field-group.product-category-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1.2fr;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📋 견적내용 입력</h1>
    <p>(주)바이텍테크놀로지</p>
  </div>

  <div class="content">
    <!-- 필수 입력 안내 -->
    <div class="required-notice">
      *표시는 필수사항입니다. *표시가 없는 항목은 입력하지 않으셔도 됩니다.
    </div>

    <!-- 기본정보 -->
    <div class="section">
      <h2 class="section-title">기본정보</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>견적일자 <span class="required">*</span></label>
          <input type="date" id="date" required>
        </div>
        <div class="form-group">
          <label>견적번호 <span class="required">*</span></label>
          <input type="text" id="number" placeholder="예시) DLP_250707-1" required>
        </div>
      </div>
    </div>

    <!-- 공급자 정보 -->
    <div class="section">
      <h2 class="section-title">공급자 정보 <span class="info-badge">고정</span></h2>
      <div class="form-grid">
        <div class="form-group">
          <label>공급자</label>
          <input type="text" value="(주)바이텍테크놀로지" readonly>
        </div>
        <div class="form-group">
          <label>담당자 <span class="required">*</span></label>
          <select id="supplier-person" required>
            <option value="" data-email="" data-phone="" data-id="" disabled selected hidden>담당자를 선택하세요</option>
            <option value="애니트론사업부 이훈수 이사" data-email="hslee@bitekps.com" data-phone="010-3252-0593" data-id="A">애니트론사업부 이훈수 이사</option>
            <option value="애니트론사업부 차재원 차장" data-email="cjw@bitekps.com" data-phone="010-5035-7791" data-id="B">애니트론사업부 차재원 차장</option>
            <option value="애니트론사업부 하철용 차장" data-email="cyha@bitekps.com" data-phone="010-6206-7656" data-id="C">애니트론사업부 하철용 차장</option>
            <option value="애니트론사업부 노재익 차장" data-email="jake@bitekps.com" data-phone="010-6419-0945" data-id="D">애니트론사업부 노재익 차장</option>
            <option value="애니트론사업부 전준영 과장" data-email="methu@bitekps.com" data-phone="010-2866-4914" data-id="E">애니트론사업부 전준영 과장</option>
            <option value="애니트론사업부 장진호 대리" data-email="jhjang@bitekps.com" data-phone="010-9999-4401" data-id="F">애니트론사업부 장진호 대리</option>
          </select>
        </div>
        <div class="form-group">
          <label>담당자 ID</label>
          <input type="text" id="supplier-person-id" readonly placeholder="자동입력">
        </div>
        <div class="form-group">
          <label>이메일</label>
          <input type="email" id="supplier-email" readonly placeholder="자동입력">
        </div>
        <div class="form-group">
          <label>전화번호</label>
          <input type="tel" id="supplier-phone" readonly placeholder="자동입력">
        </div>
      </div>
    </div>
    <!-- 수신자 정보 -->
    <div class="section">
      <h2 class="section-title">수신자 정보</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>회사명 <span class="required">*</span></label>
          <input type="text" id="receiver-company" required placeholder="회사명을 입력해주세요">
        </div>
        <div class="form-group">
          <label>담당자</label>
          <input type="text" id="receiver-person" placeholder="담당자명을 입력해주세요">
        </div>
        <div class="form-group">
          <label>이메일</label>
          <input type="email" id="receiver-email" placeholder="이메일을 입력해주세요">
        </div>
        <div class="form-group">
          <label>전화번호</label>
          <input type="tel" id="receiver-phone" placeholder="전화번호를 입력해주세요">
        </div>
      </div>
    </div>

    <!-- 견적제품 선택 -->
    <div class="section">
      <h2 class="section-title">견적제품 선택</h2>
      <div class="form-group">
        <label>제품 유형 <span class="required">*</span></label>
        <select id="product-category" required>
          <option value="">선택하세요</option>
          <option value="장비">장비</option>
          <option value="소모품">소모품</option>
          <option value="기타">기타</option>
        </select>
      </div>
    </div>
    <!-- 제품정보 -->
    <div class="section">
      <h2 class="section-title">제품정보 <span class="info-badge">최대 10개</span></h2>
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button type="button" id="add-product" class="add-btn add-product-btn">➕ 제품추가</button>
        <button type="button" id="duplicate-product" class="add-btn">📋 제품복제</button>
      </div>
      <div id="products-area"></div>
      <div style="display: flex; gap: 10px; margin-top: 12px; margin-bottom: 20px;">
        <button type="button" id="add-product-bottom" class="add-btn add-product-btn">➕ 제품추가</button>
      </div>
      <div class="summary-box">
        <div class="summary-total">
          <span>총 견적금액:</span>
          <span id="total-estimate-amount">0</span> 원
        </div>
      </div>
    </div>

    <!-- 기타정보 -->
    <div class="section">
      <h2 class="section-title">기타정보</h2>
      <div class="form-grid">
        <div class="form-group">
          <label>견적유효기간</label>
          <input type="text" id="quote-validity" value="견적일로부터 4주">
        </div>
        <div class="form-group">
          <label>납기일 <span class="required">*</span></label>
          <input type="text" id="delivery-date" value="입금확인일로부터 2주 이내" required>
        </div>
        <div class="form-group full-width">
          <label>제품교육 <span class="required">*</span></label>
          <select id="product-training" required>
            <option value="">선택하세요</option>
            <option value="제품 납품시 사용자 교육을 진행 합니다.">제품 납품시 사용자 교육을 진행 합니다.</option>
            <option value="엔지니어 방문 설치교육(300,000원(부가세별도) 입니다.(설치 메뉴얼, 동영상 제공)">엔지니어 방문 설치교육(300,000원(부가세별도) 입니다.(설치 메뉴얼, 동영상 제공)</option>
            <option value="엔지니어 방문 설치교육(250,000원(부가세별도) 입니다.(설치 메뉴얼, 동영상 제공)">엔지니어 방문 설치교육(250,000원(부가세별도) 입니다.(설치 메뉴얼, 동영상 제공)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 제출 버튼 -->
    <div class="action-buttons">
      <button type="button" id="preview-btn" class="btn btn-primary" style="flex: 1;">
        📄 견적서 생성하기
      </button>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">
        🏠 처음화면으로
      </button>
    </div>
  </div>
</div>
<script>
// 1. 새로운 제품 분류 구조 (CSV 기반)
const majorCategories = {
  "애니트론": [
    "컬러라벨프린터",
    "컬러 파우치&라벨 프린터\n(낱장 공급 방식)",
    "옵션 (ANY-002)",
    "옵션 (PRO10)",
    "소모품"
  ],
  "RFID": [
    "RFID 프린터",
    "RFID  핸드 헬드 리더기",
    "고정형 안테나",
    "RFID 패키지",
    "RFID 프로그램",
    "RFID 소모품"
  ]
};

// 2. 소모품 선택 시 옵션들
const consumableOptions = {
  "ANY-002": "ANY-002",
  "1040 4색 ": "1040 4색",
  "1050 5색": "1050 5색",
  "EPSON CW-C4040A": "EPSON CW-C4040A",
  "EPSON CW-C6040A": "EPSON CW-C6040A",
  "EPSON CW-C6540A": "EPSON CW-C6540A",
  "ANYPACK": "ANYPACK",
  "라벨 소모품": "라벨 소모품",
  "AT-2": "AT-2"
};

// 3. 제품 데이터 (CSV 기반)
const productData = {
  // 애니트론 - 옵션 (ANY-002)
  "옵션 (ANY-002)": [
    { name: "ANY-002 장비테이블", detail: "ANY-002 전용 테이블 / 600x1800 , 전용테이블", price: "무상제공" },
    { name: "리와인더", detail: "8인치 전용 리와인더", price: "1000000" },
    { name: "출력 S/W", detail: "ANY-002 전용 출력 변환 프로그램 (bitek label s/w)", price: "1000000" }
  ],
  // 애니트론 - 옵션 (PRO10)
  "옵션 (PRO10)": [
    { name: "리와인더 (5인치)", detail: "출력된 라벨 용지를 롤로 감아주는 기능", price: "500000" },
    { name: "라벨 출력 S./W", detail: "라벨 출력 편집 프로그램 / 가변 데이터 / 넘버링 기능 등", price: "700000" }
  ],
  // 애니트론 - 컬러라벨프린터
  "컬러라벨프린터": [
    { name: "ANY-002", detail: "- 프린터 속도 : 34/36 PPM (분당 약 9.3m)\n - 연속 용지 프린터 속도 : 20/16/8 PPM (분당 6 m)\n - 용지무게 : 64~250gsm\n - 해상도 : 600 x 1200DPI\n - 용지크기 : min 65mm / max 215mm \n - 연속용지 : 8.5 iinch (215mm)\n - 기본메모리 : 256MB\n-  지원미디어 : Art paper , PET , PP 지원\n- 토너용량(5% coverage,) : 모노 11,000매(3,300 meter)\n      (A4 기준)         컬러 11,500매(3,450 meter)\n - 이미지드럼 : 28,000매\n - 이송벨트 : 60,000매\n - 정착기 : 60,000매\n - 사용전력 : 220v\n - 센서모듈 : Gap 센싱모드(라벨 사이간격 3mm 필수)\n - 인터페이스 : 고속USB/유선LAN\n - OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n\n최초 설치 시 토너, 드럼등 소모품은 장착되어 납품 됩니다.", price: "20000000" },
    { name: "PRO 1040 4색 ", detail: "연속 용지 프린터 속도 : 최대 9M/분당, 기본 5M/분당\n\n- 해상도 : 1200 x 1200 dpi\n- 색상 : CMYK (4색모델)\n- 용지폭 : 25.4mm~130mm\n- 용지길이 : 12.7mm~1320.8mm\n- 인쇄 폭 : 최대 125mm\n- 인쇄 최소여백 : 상하좌우 각 2.12mm\n- 커팅 가능 용지길이 : 최소 101.6mm\n- 롤직경 : 최대 203.2mm(8인치)\n- 미디어두께 : 0.076mm~0.250mm\n- 센서모듈 : Gap 센싱모드(라벨 사이간격 3mm 필수)\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)", price: "10980000" },
    { name: "PRO 1050 5색", detail: "연속 용지 프린터 속도 : 최대 9M/분당, 기본 5M/분당\n\n- 해상도 : 1200 x 1200 dpi\n- 색상 : CMYK+W (5색모델)\n- 용지폭 : 25.4mm~130mm\n- 용지길이 : 12.7mm~1320.8mm\n- 인쇄 폭 : 최대 125mm\n- 인쇄 최소여백 : 상하좌우 각 2.12mm\n- 커팅 가능 용지길이 : 최소 101.6mm\n- 롤직경 : 최대 203.2mm(8인치)\n- 미디어두께 : 0.076mm~0.250mm\n- 센서모듈 : Gap 센싱모드(라벨 사이간격 3mm 필수)\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)", price: "14540000" },
    { name: "EPSON CW-C4040A", detail: "고품질 고속인쇄(8인치목 출력가능 라벨 프린터)\n\n- 해상도 : 1200 x 1200 dpi- 색상 : CMYK 4색\n- 용지폭 : 21.4mm~104mm\n- 자동노즐검사기능 , 선명한 바코드 인쇄\n- 미디어두께 : 0.076mm~0.250mm\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n(본 제품의 초기에는 C,M,Y 잉크만 동봉되어 있습니다.)\n\n이벤트 증정 : C,M,Y,K 잉크 한세트 무상증정", price: "2500000" },
    { name: "EPSON CW-C6040A", detail: "고품질 고속인쇄(4인치폭 출력가능 라벨 프린터)\n\n- 해상도 : 1200 x 1200 dpi- 색상 : CMYK 4색\n- 용지폭 : 21.4mm~112mm\n- 인쇄가능폭 : 101.6mm\n- 자동노즐검사기능 , 선명한 바코드 인쇄\n- 미디어두께 : 0.076mm~0.250mm\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n(본 제품의 초기에는 C,M,Y 잉크만 동봉되어 있습니다.)\n- 크기 : 340x565x325mm\n- 무게 :약 22.5kg\n\n이벤트 증정 : C,M,Y,K 잉크 한세트 무상증정", price: "2900000" },
    { name: "EPSON CW-C6540A", detail: "고품질 고속인쇄(8인치폭 출력가능 라벨 프린터)\n\n- 해상도 : 1200 x 1200 dpi- 색상 : CMYK 4색\n- 용지폭 : 21.4mm~215.9mm\n- 인쇄가능폭 : 210mm\n- 자동노즐검사기능 , 선명한 바코드 인쇄\n- 미디어두께 : 0.076mm~0.250mm\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n(본 제품의 초기에는 C,M,Y 잉크만 동봉되어 있습니다.)\n- 크기 : 444 x 515 x 326mm\n- 무게 :약 25.5kg\n\n이벤트 증정 : C,M,Y,K 잉크 한세트 무상증정", price: "3800000" },
    { name: "AT-1(낱장방식 프린터)", detail: "컬러&흑백 출력이 가능한 LED LASER PRINTER\n\n- 해상도 : 1200 x 1200 dpi- 색상 : CMYK 4색\n- 용지폭 : 55mm~216mm , 길이 91~1320mm\n- 인쇄속도 : 최대속도 1.5초당 1매\n- 용지두께: 52~320gsm\n- 기본메모리 : 1GB\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n- 크기 : 290x395x430mm (프린터 only)\n (초기 제품에는 C,M,Y,K 토너가 장착되어져 있습니다.)\n (라벨지 100매 서비스 제공 및 출력가이드 제공)", price: "900000" }
  ],
  // 애니트론 - 컬러 파우치&라벨 프린터
  "컬러 파우치&라벨 프린터\n(낱장 공급 방식)": [
    { name: "AT-2", detail: "컬러&흑백 출력이 가능한 LED LASER PRINTER\n\n- 해상도 : 1200 x 2400 dpi\n- 색상 : CMYK 4색\n- 용지폭 : 89mm~320mm , 길이 98~1200mm\n- 인쇄속도 : 최대속도 분당 55매(최고속도 기준)\n- 용지두께: 52~300gsm\n- 기본메모리 : 4GB\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n- 크기 : 620x720.5x699.1mm (프린터 only)\n (초기 제품에는 C,M,Y,K 토너가 장착되어져 있습니다.)", price: "4500000" },
    { name: "AT-3", detail: "컬러&흑백 출력이 가능한 LED LASER PRINTER\n\n- 해상도 : 1200 x 1200 dpi\n- 색상 : CMYK + W (5색)\n- 용지폭 : 89mm~320mm , 길이 98~1200mm\n- 인쇄속도 : A4 50ppm / A3 28PPM (사무용지 기준)\n- 용지두께: 52~320gsm , MP TRAY : 52~360gsm\n- 기본메모리 : 2GB\n- 인터페이스 : 고속USB/유선LAN\n- OS 호환 : Windows 7, 8, 8.1,10,11(32&64bit)\n- 크기 :  625(L) x 699(W) x 640(H)mm , 116kg (소모품 포함)\n (초기 제품에는 토너가 장착되어져 있습니다.)", price: "11000000" }
  ],
  // RFID - 핸드 헬드 리더기
  "RFID  핸드 헬드 리더기": [
    { name: "AT-907", detail: "PDA 타입 일체형 핸드헬드 리더기\nRFID : UHF\n안드로이드 타입", price: "1400000" },
    { name: "M3 ORANGE PLUS RFID GUN(43211710-22738770)", detail: "CPU : Cortex-A8 833MHz\t\t\t\nOS : Window Mobile 6.5\t\t\t\n메모리 : ROM 256MB, RAM 1GB\t\t\t\nDisplay : 3.5\"\" Color TFT LCD\t\t\t\n바코드 스캐너 : 1D 기본, 2D 옵션\t\t\t\n배터리 : Li-Ion 3,300mAh\t\t\t\nRFID : Gen-2, ISO 18000-6C\t\t\t", price: "2300000,1900000" }
  ],
  // RFID - 프린터
  "RFID 프린터": [
    { name: "Blackfish BT-200(43212116-25231260)", detail: "해상도 : 300DPI (1mm : 12dot)\t\t\n메모리 : Flash 256MB, SDRAM 512MB\t\t\n라벨폭 : 25mm ~ 118mm\t\t\t\n인쇄폭 : 25mm ~ 104mm\t\t\t\n인터페이스 : USB2.0 / RS-232-/TCP/IP\t\n출력방식 : 열전사 / 감열방식\t\t\nRFID : Gen-2, ISO 18000-6C\t\t\nLCD : COLOR TFT LCD\t\t\t\n크기 : 512 mm (L) x 291 mm (H) x 274 mm (W)\n중량 : 15 Kg\t\t\t\nRFID 프린터 무상 유지보수 1년 연장\n제조사 : ㈜바이텍테크놀로지", price: "3200000,2500000" },
    { name: "Blackfish BT-100(43212116-23491762)", detail: "해상도 : 300DPI (1mm : 12dot)\t\t\t\n메모리 : Flash 128MB, SDRAM 32MB\t\t\t\n라벨폭 : 25mm ~ 118mm\t\t\t\n인쇄폭 : 25mm ~ 105mm\t\t\t\n인터페이스 : USB\t\t\t\n출력방식 : 열전사 / 감열방식\t\t\t\nRFID : Gen-2, ISO 18000-6C\t\t\t\nLCD :3.2인치 컬러 터치 스크린\t\t\t\n       Auto Calibration Switch\t\t\t\n크기 : 468mm(L) x 308mm(H) x 270mm(W)\t\t\t\n중량 : 13.6 Kg\t\t\t\nRFID 프린터 무상 유지보수 2년 연장\t\t\t", price: "3200000,2500000" },
    { name: "BT-002 pro\t", detail: "해상도 : 300DPI (1mm : 12dot)\t\t\n메모리 : Flash 8MB, SDRAM 16MB\t\t\n라벨폭 : 25mm ~ 118mm\t\t\t\n인쇄폭 : 25mm ~ 104mm\t\t\t\n인터페이스 : USB2.0 / RS-232-/TCP/IP\t\n출력방식 : 열전사 / 감열방식\t\t\nRFID : Gen-2, ISO 18000-6C\t\t\nLCD : COLOR TFT LCD\t\t\t\n크기 : 512 mm (L) x 291 mm (H) x 274 mm (W)\n중량 : 15 Kg\t\t\t\n제 제조사 : ㈜바이텍테크놀로지", price: "3200000,2500000" },
    { name: "BT-003 Pro", detail: "해상도 : 300DPI (1mm : 12dot)\t\t\n메모리 : Flash 8MB, SDRAM 32MB\t\t\n라벨폭 : 25mm ~ 118mm\t\t\t\n인쇄폭 : 25mm ~ 104mm\t\t\t\n인터페이스 : USB2.0 / RS-232-C\t\n출력방식 : 열전사 / 감열방식\t\t\nRFID : ISO/IEC 14443/A _ ISO/IEC 15693\t\nRFID주파수 : HF대역 / 13.56MHz\n크기 : 540 mm (L) x 287 mm (H) x 268 mm (W)\n중량 : 15 Kg\t\t\t\n제조사 : ㈜바이텍테크놀로지", price: "4500000,3500000" }
  ],
  // RFID - 고정형 안테나
  "고정형 안테나": [
    { name: " IDRO260-919", detail: "모델명 : IDRO260-919\n타 입 : Circular ANT\n중심 주파수 : 920 MHz\n케이블 6M 포함", price: "200000" }
  ],
  // RFID - 프로그램
  "RFID 프로그램": [
    { name: "ANY-IMS", detail: "RFID 입출고 , 재고관리 솔루션 프로그램", price: "9000000" }
  ],
  // RFID - 패키지
  "RFID 패키지": [
    { name: "ANY-Finder Plus", detail: "RFID  프린터 / RFID 프린터 전용 프로그램 / \nRFID 일체형 핸드 리더기 / 리더기 전용 프로그램", price: "6600000" },
    { name: "Any-Finder", detail: "RFID 일체형 핸드 리더기 / 전용 앱 프로그램", price: "2900000" },
    { name: "Any-Gate", detail: "고정식 리더기/ 안테나/ 터치 모니터/ 미니 PC/ 입출고 관리 프로그램", price: "13500000" }
  ],
  // RFID - 소모품
  "RFID 소모품": [
    { name: "조달태그(2500매/롤)", detail: "조달태그, 94x24, 2500매/롤", price: "575000,375000" },
    { name: "차폐재_소프트타입(100개/박스)", detail: "차폐재, 95x25x3, 소프트타입, 100개/박스", price: "100000,50000" },
    { name: "열전사리본(왁스레진 300미터)", detail: "열전사리본, 왁스레진, 110x300m", price: "43000,30000" },
    { name: "렛치형태그(개)", detail: "레치 및 케이블타이, 개(200개/묶음)", price: "60000,30000" },
    { name: "무지태그(2500매/롤)", detail: "무지태그, 94 x 24 , 2500매/롤", price: "325000" },
    { name: "삼성중공업 제작태그", detail: "100 x 35  NFC  전용 태그", price: "" },
    { name: "분당서울대병원 제작태그", detail: "RFID 라벨", price: "300" },
    { name: "LG화학 전용 태그", detail: "100 x 60", price: "" }
  ]
};

// 4. 소모품 데이터 (CSV 기반)
const consumableData = {
  "ANY-002": [
    { name: "K TONER", detail: "농도 5% A4 기준 약 11,000매 사용", price: "100000" },
    { name: "CYAN TONER", detail: "농도 5% A4 기준 약 11,000매 사용", price: "125000" },
    { name: "MAGENTA TONER", detail: "농도 5% A4 기준 약 11,000매 사용", price: "125000" },
    { name: " YELLOW TONER", detail: "농도 5% A4 기준 약 11,000매 사용", price: "125000" },
    { name: "K DRUM", detail: "A4 기준 28,000매 사용", price: "100000" },
    { name: "CYAN DRUM", detail: "A4 기준 28,000매 사용", price: "100000" },
    { name: "MAGENTA DRUM", detail: "A4 기준 28,000매 사용", price: "100000" },
    { name: " YELLOW DRUM", detail: "A4 기준 28,000매 사용", price: "100000" },
    { name: "Fuser ", detail: "A4 기준 60,000매 사용", price: "270000" },
    { name: "벨트", detail: "A4 기준 60,000매 사용", price: "270000" }
  ],
  "1040 4색 ": [
    { name: "1040 CYAN TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1040 MAGENTA TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1040 YELLOW TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1040 K TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1040 Fuser(정착기)", detail: "A6 100x150 기준 150,000매 사용", price: "495000" },
    { name: "1040 Belt(벨트)", detail: "A6 100x150 기준 150,000매 사용", price: "295000" },
    { name: "1040 폐토너통", detail: "A6 100x150 기준 25,000매 사용", price: "45000" }
  ],
  "1050 5색": [
    { name: "1050 CYAN TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1050 MAGENTA TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1050 YELLOW TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1050 K TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "225000" },
    { name: "1050 WHITE TONER", detail: "(100x150 기준 약 15,000~20,000매 출력가능 농도5% 기준)", price: "295000" },
    { name: "1050 Fuser(정착기)", detail: "A6 100x150 기준 150,000매 사용", price: "495000" },
    { name: "1050 Belt(벨트)", detail: "A6 100x150 기준 150,000매 사용", price: "295000" },
    { name: "1050 폐토너통", detail: "A6 100x150 기준 25,000매 사용", price: "45000" }
  ],
  "EPSON CW-C4040A": [
    { name: "C ink", detail: "라벨 사이즈 100x100 기준 약 1,500장 출력 가능 (농도5% 기준)", price: "58000" },
    { name: "M ink", detail: "라벨 사이즈 100x100 기준 약 1,500장 출력 가능 (농도5% 기준)", price: "58000" },
    { name: "Y ink", detail: "라벨 사이즈 100x100 기준 약 1,500장 출력 가능 (농도5% 기준)", price: "58000" },
    { name: "K ink", detail: "라벨 사이즈 100x100 기준 약 1,500장 출력 가능 (농도5% 기준)", price: "58000" },
    { name: "폐잉크박스", detail: "EPSON CW-C4040A 전용 폐잉크박스", price: "41000" }
  ],
  "EPSON CW-C6040A": [
    { name: "C ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "M ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "Y ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "K ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "폐잉크박스", detail: "EPSON CW-C6040A 전용 폐잉크박스", price: "41000" }
  ],
  "EPSON CW-C6540A": [
    { name: "C ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "M ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "Y ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "K ink", detail: "라벨 사이즈 100x100 기준 약 3,000장 출력 가능 (농도5% 기준)", price: "65000" },
    { name: "폐잉크박스", detail: "EPSON CW-C6540A 전용 폐잉크박스", price: "41000" }
  ],
  "ANYPACK": [
    { name: "K TONER", detail: "A4 38,000장 출력가능 (농도 5% 기준)", price: "150000" },
    { name: "CYAN TONER", detail: "A4 38,000장 출력가능 (농도 5% 기준)", price: "172000" },
    { name: "MAGENTA TONER", detail: "A4 38,000장 출력가능 (농도 5% 기준)", price: "172000" },
    { name: " YELLOW TONER", detail: "A4 38,000장 출력가능 (농도 5% 기준)", price: "172000" },
    { name: "WHITE TONER", detail: "A4 38,000장 출력가능 (농도 5% 기준)", price: "264000" },
    { name: "K DRUM", detail: "A4 기준 40,000장 출력가능", price: "194000" },
    { name: "CYAN DRUM", detail: "A4 기준 40,000장 출력가능", price: "194000" },
    { name: "MAGENTA DRUM", detail: "A4 기준 40,000장 출력가능", price: "194000" },
    { name: " YELLOW DRUM", detail: "A4 기준 40,000장 출력가능", price: "194000" },
    { name: "WHITE DRUM", detail: "A4 기준 40,000장 출력가능", price: "210000" },
    { name: "FUSER ", detail: "A4 기준 150,000매 출력가능", price: "430000" },
    { name: "BELT", detail: "A4 기준 150,000매 출력가능", price: "360000" }
  ],
  "라벨 소모품": [
    { name: "아트지", detail: "가로   x  세로   , 롤당 ? 장 , 장당 단가 ? ", price: "" },
    { name: "유포지", detail: "가로   x  세로   , 롤당 ? 장 , 장당 단가 ? ", price: "" },
    { name: "은무 PET", detail: "가로   x  세로   , 롤당 ? 장 , 장당 단가 ? ", price: "" },
    { name: "투명 PET", detail: "가로   x  세로   , 롤당 ? 장 , 장당 단가 ? ", price: "" },
    { name: "기타", detail: "", price: "" }
  ],
  "AT-2": [
    { name: "K TONER", detail: "A4 26,000장 출력가능 (농도 5% 기준)", price: "150000" },
    { name: "CYAN TONER", detail: "A4 25,000장 출력가능 (농도 5% 기준)", price: "230000" },
    { name: "MAGENTA TONER", detail: "A4 25,000장 출력가능 (농도 5% 기준)", price: "230000" },
    { name: " YELLOW TONER", detail: "A4 25,000장 출력가능 (농도 5% 기준)", price: "230000" },
    { name: "FUSER ", detail: "", price: "595000" },
    { name: "BELT", detail: "", price: "" }
  ]
};

let productCount = 0;
const maxProducts = 10;

function createProductSet(idx) {
  // 대분류 옵션
  const majorOptions = [
    '<option value="">대분류</option>',
    '<option value="애니트론">애니트론</option>',
    '<option value="RFID">RFID</option>'
  ].join('');

  return `
  <div class="product-set" data-index="${idx}">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span style="font-weight: 600; color: #2A8486;">제품 ${idx+1}</span>
      <div style="display: flex; gap: 4px;">
        <button type="button" onclick="moveProductUp(this)" class="move-btn" title="위로 이동">▲</button>
        <button type="button" onclick="moveProductDown(this)" class="move-btn" title="아래로 이동">▼</button>
        <button type="button" onclick="duplicateProduct(this)" class="remove-btn" style="background: #2A8486; color: white;">복제</button>
        ${idx>0?'<button type="button" onclick="removeProduct(this)" class="remove-btn">삭제</button>':''}
      </div>
    </div>

    <div class="product-field-group product-category-row">
      <div>
        <label class="product-field-label">대분류</label>
        <select class="product-major-category">
          ${majorOptions}
        </select>
      </div>
      <div>
        <label class="product-field-label">구분</label>
        <select class="product-type">
          <option value="">구분(선택)</option>
        </select>
      </div>
      <div>
        <label class="product-field-label">제품명</label>
        <select class="product-name">
          <option value="">제품명</option>
        </select>
      </div>
    </div>

    <div class="product-field-group product-detail-row">
      <label class="product-field-label">상세정보</label>
      <textarea class="product-detail" placeholder="제품상세정보" rows="6" style="resize: vertical; font-family: inherit; font-size: inherit;"></textarea>
    </div>

    <div class="product-field-group three-columns">
      <div>
        <label class="product-field-label">수량</label>
        <input class="product-qty" type="number" min="1" placeholder="수량">
      </div>
      <div>
        <label class="product-field-label">단가(원)</label>
        <select class="product-price-select" style="display:none;">
          <option value="">가격 선택</option>
        </select>
        <input class="product-price" type="number" min="0" placeholder="공급단가(원)">
      </div>
      <div>
        <label class="product-field-label">합계(원)</label>
        <input class="product-total product-total-highlight" type="text" placeholder="합계(VAT별도가격)" readonly>
      </div>
    </div>

    <div class="product-field-group product-note-row">
      <label class="product-field-label">비고</label>
      <input class="product-note" type="text" maxlength="20" placeholder="비고(20자까지 입력가능)">
    </div>
  </div>
  `;
}

// 대분류 변경 시 구분 옵션 업데이트
function updateProductTypeOptions(majorSelect, typeSelect) {
  const major = majorSelect.value;
  typeSelect.innerHTML = '<option value="">구분(선택)</option>';

  if(majorCategories[major]) {
    majorCategories[major].forEach(type => {
      const opt = document.createElement('option');
      opt.value = type;
      opt.textContent = type;
      typeSelect.appendChild(opt);
    });

    // 애니트론 선택 시 '직접입력' 옵션 추가
    if(major === '애니트론') {
      const directInputOpt = document.createElement('option');
      directInputOpt.value = '직접입력';
      directInputOpt.textContent = '직접입력';
      typeSelect.appendChild(directInputOpt);
    }
  }
}

// '직접입력' 선택 시 모든 필드를 텍스트 입력으로 변경
function enableDirectInput(typeSelect) {
  const productSet = typeSelect.closest('.product-set');

  // 구분 필드를 텍스트 입력으로 변경
  const typeInput = document.createElement('input');
  typeInput.type = 'text';
  typeInput.className = 'product-type-input';
  typeInput.placeholder = '구분 입력';
  typeInput.style.cssText = typeSelect.style.cssText;
  typeInput.value = '';
  typeInput.dataset.directInput = 'true';
  typeSelect.parentNode.replaceChild(typeInput, typeSelect);

  // 제품명 필드를 텍스트 입력으로 변경
  const nameSelect = productSet.querySelector('.product-name');
  if(nameSelect && nameSelect.tagName === 'SELECT') {
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'product-name';
    nameInput.placeholder = '제품명 입력';
    nameInput.style.cssText = nameSelect.style.cssText;
    nameInput.value = '';
    nameInput.dataset.directInput = 'true';
    nameSelect.parentNode.replaceChild(nameInput, nameSelect);
  }

  // 제품상세정보는 이미 textarea이므로 변경 불필요
  const detailInput = productSet.querySelector('.product-detail');
  if(detailInput) {
    detailInput.placeholder = '제품상세정보 입력';
    detailInput.value = '';
  }

  // 단가 필드 활성화 (이미 input이므로 placeholder만 변경)
  const priceInput = productSet.querySelector('.product-price');
  if(priceInput) {
    priceInput.placeholder = '공급단가(원) 입력';
    priceInput.value = '';
    priceInput.readOnly = false;
  }

  // 소모품 선택 드롭다운 숨기기
  const consumableSelect = productSet.querySelector('.consumable-option');
  if(consumableSelect) {
    consumableSelect.style.display = 'none';
  }
}

// select 형태로 복원 (직접입력에서 다른 옵션으로 변경 시)
function restoreSelectFields(typeSelect) {
  const productSet = typeSelect.closest('.product-set');

  // 구분 필드가 input인 경우 select로 복원
  const typeInput = productSet.querySelector('.product-type-input');
  if(typeInput && typeInput.dataset.directInput === 'true') {
    const newTypeSelect = document.createElement('select');
    newTypeSelect.className = 'product-type';
    newTypeSelect.innerHTML = '<option value="">구분(선택)</option>';
    newTypeSelect.style.cssText = typeInput.style.cssText;
    typeInput.parentNode.replaceChild(newTypeSelect, typeInput);

    // 이벤트 리스너 재등록 필요
    const majorSelect = productSet.querySelector('.product-major-category');
    updateProductTypeOptions(majorSelect, newTypeSelect);
    newTypeSelect.value = typeSelect.value;
  }

  // 제품명 필드가 input인 경우 select로 복원
  const nameInput = productSet.querySelector('.product-name');
  if(nameInput && nameInput.tagName === 'INPUT' && nameInput.dataset.directInput === 'true') {
    const newNameSelect = document.createElement('select');
    newNameSelect.className = 'product-name';
    newNameSelect.innerHTML = '<option value="">제품명</option>';
    newNameSelect.style.cssText = nameInput.style.cssText;
    delete newNameSelect.dataset.directInput;
    nameInput.parentNode.replaceChild(newNameSelect, nameInput);
  }
}

// 구분 변경 시 제품명 옵션 업데이트
function updateProductNameOptions(typeSelect, nameSelect, consumableSelect) {
  const type = typeSelect.value;

  console.log("=== updateProductNameOptions 디버깅 ===");
  console.log("선택된 구분:", type);

  // '직접입력' 선택 시 모든 필드를 텍스트 입력으로 변경
  if(type === '직접입력') {
    enableDirectInput(typeSelect);
    return;
  }

  // 기존 로직: select 형태로 복원 (직접입력에서 다른 옵션으로 변경 시)
  restoreSelectFields(typeSelect);

  nameSelect.innerHTML = '<option value="">제품명</option>';

  // 기존 소모품 선택 드롭다운 찾기
  const existingConsumableSelect = typeSelect.parentNode.querySelector('.consumable-option');

  // 소모품일 때
  if(type === "소모품") {
    console.log("소모품 선택됨 - 소모품 선택 시 드롭다운 생성");
    // 소모품 선택 드롭다운이 없으면 추가
    if(!existingConsumableSelect) {
      const newConsumableSelect = document.createElement('select');
      newConsumableSelect.className = 'consumable-option';
      newConsumableSelect.style.marginRight = '8px';
      newConsumableSelect.innerHTML = '<option value="">장비 선택</option>' +
        Object.keys(consumableOptions).map(key => `<option value="${key}">${consumableOptions[key]}</option>`).join('');
      typeSelect.insertAdjacentElement('afterend', newConsumableSelect);
      newConsumableSelect.addEventListener('change', function() {
        updateProductNameOptions(typeSelect, nameSelect, newConsumableSelect);
      });
      consumableSelect = newConsumableSelect;
    } else {
      consumableSelect = existingConsumableSelect;
      existingConsumableSelect.style.display = 'block';
    }
    // 소모품 선택 시 제품명 옵션 변경
    const selectedConsumable = consumableSelect.value;
    console.log("선택된 소모품 모델:", selectedConsumable);
    if(consumableData[selectedConsumable]) {
      console.log("해당 모델의 소모품 목록:", consumableData[selectedConsumable]);
      consumableData[selectedConsumable].forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.name;
        opt.textContent = item.name;
        nameSelect.appendChild(opt);
      });
    } else {
      console.log("해당 모델의 소모품 데이터가 없음");
    }
  } else {
    // 소모품이 아니면 기존 방식
    if(existingConsumableSelect) {
      existingConsumableSelect.style.display = 'none';
    }
    if(productData[type]) {
      const names = [...new Set(productData[type].map(item=>item.name))];
      names.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        nameSelect.appendChild(opt);
      });
    }
  }
}

function updateProductDetail(typeSelect, nameSelect, detailInput, priceInput, priceSelect) {
  const type = typeSelect.value;
  const name = nameSelect.value;
  
  console.log("=== updateProductDetail 디버깅 ===");
  console.log("선택된 구분(type):", type);
  console.log("선택된 제품명(name):", name);
  console.log("productData에서 해당 구분 존재 여부:", !!productData[type]);
  console.log("해당 구분의 제품 목록:", productData[type]);
  
  // 소모품일 때
  if(type === "소모품") {
    console.log("소모품 처리 중...");
    const consumableSelect = typeSelect.parentNode.querySelector('.consumable-option');
    console.log("소모품 선택 드롭다운:", consumableSelect);
    if(consumableSelect && consumableData[consumableSelect.value]) {
      console.log("소모품 데이터에서 검색:", consumableData[consumableSelect.value]);
      const found = consumableData[consumableSelect.value].find(item => item.name === name);
      console.log("찾은 소모품:", found);
      if(found) {
        detailInput.value = found.detail;
        updatePriceOptions(found.price, priceInput, priceSelect);
      } else {
        detailInput.value = '';
        priceInput.value = '';
        priceSelect.style.display = 'none';
        priceInput.style.display = 'block';
      }
    }
  } else {
    // 일반 제품
    console.log("일반 제품 처리 중...");
    if(productData[type]) {
      console.log("제품 데이터에서 검색:", productData[type]);
      const found = productData[type].find(item=>item.name===name);
      console.log("찾은 제품:", found);
      if(found) {
        detailInput.value = found.detail;
        updatePriceOptions(found.price, priceInput, priceSelect);
      } else {
        detailInput.value = '';
        priceInput.value = '';
        priceSelect.style.display = 'none';
        priceInput.style.display = 'block';
      }
    } else {
      console.log("해당 구분의 제품 데이터가 없음");
      detailInput.value = '';
      priceInput.value = '';
      priceSelect.style.display = 'none';
      priceInput.style.display = 'block';
    }
  }
}

// 가격 옵션 업데이트 함수
function updatePriceOptions(priceStr, priceInput, priceSelect) {
  console.log("=== updatePriceOptions 디버깅 ===");
  console.log("입력된 가격 문자열:", priceStr);
  
  if(!priceStr || priceStr === '') {
    priceInput.value = '';
    priceSelect.style.display = 'none';
    priceInput.style.display = 'block';
    priceInput.removeAttribute('readonly');
    priceInput.removeAttribute('disabled');
    return;
  }
  
  // 가격이 쉼표로 구분되어 있는지 확인
  if(priceStr.includes(',')) {
    const prices = priceStr.split(',').map(p => p.trim()).filter(p => p !== '텍스트');
    console.log("분리된 가격들:", prices);
    if(prices.length > 1) {
      // 여러 가격이 있으면 드롭다운 표시
      priceSelect.innerHTML = '<option value="">가격 선택</option>';
      prices.forEach(price => {
        const opt = document.createElement('option');
        opt.value = price;
        opt.textContent = price;
        priceSelect.appendChild(opt);
      });
      priceSelect.style.display = 'block';
      priceInput.style.display = 'none';
      priceInput.value = '';
      console.log("여러 가격 - 드롭다운 표시");
    } else {
      // 하나의 가격만 있으면 직접 입력
      priceInput.value = prices[0];
      priceSelect.style.display = 'none';
      priceInput.style.display = 'block';
      priceInput.removeAttribute('readonly');
      priceInput.removeAttribute('disabled');
      console.log("하나의 가격 - 직접 입력 필드 표시");
    }
  } else {
    // 단일 가격
    priceInput.value = priceStr;
    priceSelect.style.display = 'none';
    priceInput.style.display = 'block';
    priceInput.removeAttribute('readonly');
    priceInput.removeAttribute('disabled');
    console.log("단일 가격 - 직접 입력 필드 표시");
  }
}

function updateProductTotal(qtyInput, priceInput, totalInput) {
  const qty = Number(qtyInput.value);
  const price = Number(priceInput.value);
  if(qty && price) {
    totalInput.value = (qty * price).toLocaleString();
  } else {
    totalInput.value = '';
  }
  updateGrandTotal();
}

// 총 견적금액 갱신 (모든 제품 합계)
function updateGrandTotal() {
  const el = document.getElementById('total-estimate-amount');
  if(!el) return;
  let sum = 0;
  document.querySelectorAll('.product-set .product-total').forEach(function(input) {
    const v = (input.value || '').replace(/,/g, '');
    if(v) sum += Number(v);
  });
  el.textContent = sum.toLocaleString();
}

function removeProduct(btn) {
  if(productCount <= 1) {
    alert('최소 1개의 제품은 있어야 합니다.');
    return;
  }
  btn.closest('.product-set').remove();
  productCount--;
  setAddProductButtonsDisabled(false);
  renumberProducts();
  updateGrandTotal();
}

// 제품 번호 다시 매기기 함수
function renumberProducts() {
  document.querySelectorAll('.product-set').forEach((el, idx)=>{
    el.dataset.index = idx;
    const headerDiv = el.querySelector('div');
    const span = headerDiv.querySelector('span');
    span.textContent = `제품 ${idx+1}`;
  });
}

// 제품 복제 함수 (해당 제품 바로 뒤에 추가)
function duplicateProduct(btn) {
  if(productCount >= maxProducts) {
    alert('최대 10개까지만 추가할 수 있습니다.');
    return;
  }

  const productSet = btn.closest('.product-set');
  const clonedSet = productSet.cloneNode(true);

  // 입력값 유지하면서 복제
  const originalInputs = productSet.querySelectorAll('input, select, textarea');
  const clonedInputs = clonedSet.querySelectorAll('input, select, textarea');

  originalInputs.forEach((input, idx) => {
    if(input.type === 'checkbox' || input.type === 'radio') {
      clonedInputs[idx].checked = input.checked;
    } else {
      clonedInputs[idx].value = input.value;
    }
  });

  // 복제한 제품을 현재 제품 바로 다음에 삽입
  productSet.insertAdjacentElement('afterend', clonedSet);
  productCount++;

  if(productCount >= maxProducts) {
    setAddProductButtonsDisabled(true);
  }

  renumberProducts();
  rebindProductEvents();
  updateGrandTotal();
}

// 모든 제품의 이벤트를 다시 바인딩
function rebindProductEvents() {
  document.querySelectorAll('.product-set').forEach(productSet => {
    const majorSelect = productSet.querySelector('.product-major-category');
    const typeSelect = productSet.querySelector('.product-type');
    const nameSelect = productSet.querySelector('.product-name');
    const detailInput = productSet.querySelector('.product-detail');
    const qtyInput = productSet.querySelector('.product-qty');
    const priceInput = productSet.querySelector('.product-price');
    const priceSelect = productSet.querySelector('.product-price-select');
    const totalInput = productSet.querySelector('.product-total');

    // 기존 이벤트 리스너 제거 후 새로 추가
    const newMajorSelect = majorSelect.cloneNode(true);
    const newTypeSelect = typeSelect.cloneNode(true);
    const newNameSelect = nameSelect.cloneNode(true);
    const newQtyInput = qtyInput.cloneNode(true);
    const newPriceInput = priceInput.cloneNode(true);
    const newPriceSelect = priceSelect.cloneNode(true);

    majorSelect.parentNode.replaceChild(newMajorSelect, majorSelect);
    typeSelect.parentNode.replaceChild(newTypeSelect, typeSelect);
    nameSelect.parentNode.replaceChild(newNameSelect, nameSelect);
    qtyInput.parentNode.replaceChild(newQtyInput, qtyInput);
    priceInput.parentNode.replaceChild(newPriceInput, priceInput);
    priceSelect.parentNode.replaceChild(newPriceSelect, priceSelect);

    // 이벤트 바인딩
    newMajorSelect.addEventListener('change', ()=>{
      updateProductTypeOptions(newMajorSelect, newTypeSelect);
      detailInput.value = '';
      newPriceInput.value = '';
      newNameSelect.value = '';
      newTypeSelect.value = '';
    });

    newTypeSelect.addEventListener('change', ()=>{
      updateProductNameOptions(newTypeSelect, newNameSelect, newTypeSelect.parentNode.querySelector('.consumable-option'));
      detailInput.value = '';
      newPriceInput.value = '';
      newNameSelect.value = '';
      newPriceSelect.style.display = 'none';
      newPriceInput.style.display = 'block';
    });

    newNameSelect.addEventListener('change', ()=>{
      if(newNameSelect.value === '기타') {
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = 'product-name';
        textInput.placeholder = '제품명을 직접 입력하세요';
        textInput.style.cssText = newNameSelect.style.cssText;
        textInput.style.width = '100%';
        textInput.style.flex = '1';
        textInput.style.marginTop = '0';

        newNameSelect.parentNode.replaceChild(textInput, newNameSelect);

        detailInput.value = '';
        newPriceInput.value = '';
        newPriceSelect.style.display = 'none';
        newPriceInput.style.display = 'block';
        newPriceInput.removeAttribute('readonly');
        newPriceInput.removeAttribute('disabled');
        totalInput.value = '';

        textInput.addEventListener('input', ()=>{
          updateProductTotal(newQtyInput, newPriceInput, totalInput);
        });

        textInput.focus();
      } else {
        updateProductDetail(newTypeSelect, newNameSelect, detailInput, newPriceInput, newPriceSelect);
        updateProductTotal(newQtyInput, newPriceInput, totalInput);
      }
    });

    newPriceSelect.addEventListener('change', ()=>{
      newPriceInput.value = newPriceSelect.value;
      newPriceSelect.style.display = 'none';
      newPriceInput.style.display = 'block';
      newPriceInput.removeAttribute('readonly');
      newPriceInput.removeAttribute('disabled');
      newPriceInput.focus();
      updateProductTotal(newQtyInput, newPriceInput, totalInput);
    });

    newQtyInput.addEventListener('input', ()=>updateProductTotal(newQtyInput, newPriceInput, totalInput));
    newPriceInput.addEventListener('input', ()=>updateProductTotal(newQtyInput, newPriceInput, totalInput));

    newPriceInput.addEventListener('click', ()=>{
      newPriceInput.removeAttribute('readonly');
      newPriceInput.removeAttribute('disabled');
    });
  });
}

// 제품 위로 이동
function moveProductUp(btn) {
  const productSet = btn.closest('.product-set');
  const prevProduct = productSet.previousElementSibling;

  if(prevProduct && prevProduct.classList.contains('product-set')) {
    productSet.parentNode.insertBefore(productSet, prevProduct);
    renumberProducts();
  }
}

// 제품 아래로 이동
function moveProductDown(btn) {
  const productSet = btn.closest('.product-set');
  const nextProduct = productSet.nextElementSibling;

  if(nextProduct && nextProduct.classList.contains('product-set')) {
    productSet.parentNode.insertBefore(nextProduct, productSet);
    renumberProducts();
  }
}

function setAddProductButtonsDisabled(disabled) {
  document.querySelectorAll('.add-product-btn').forEach(function(btn) { btn.disabled = disabled; });
}

function addProductSet() {
  if(productCount >= maxProducts) return;
  const area = document.getElementById('products-area');
  area.insertAdjacentHTML('beforeend', createProductSet(productCount));
  productCount++;
  if(productCount >= maxProducts) {
    setAddProductButtonsDisabled(true);
  }
  // 이벤트 바인딩
  const sets = area.querySelectorAll('.product-set');
  const lastSet = sets[sets.length-1];
  const majorSelect = lastSet.querySelector('.product-major-category');
  const typeSelect = lastSet.querySelector('.product-type');
  const nameSelect = lastSet.querySelector('.product-name');
  const detailInput = lastSet.querySelector('.product-detail');
  const qtyInput = lastSet.querySelector('.product-qty');
  const priceInput = lastSet.querySelector('.product-price');
  const priceSelect = lastSet.querySelector('.product-price-select');
  const totalInput = lastSet.querySelector('.product-total');
  const noteInput = lastSet.querySelector('.product-note');

  // 대분류 변경 시 구분 옵션 업데이트
  majorSelect.addEventListener('change', ()=>{
    updateProductTypeOptions(majorSelect, typeSelect);
    detailInput.value = '';
    priceInput.value = '';
    nameSelect.value = '';
    typeSelect.value = '';
  });
  
  // 구분 변경 시 제품명 옵션 업데이트
  typeSelect.addEventListener('change', ()=>{
    updateProductNameOptions(typeSelect, nameSelect, typeSelect.parentNode.querySelector('.consumable-option'));
    detailInput.value = '';
    priceInput.value = '';
    nameSelect.value = '';
    priceSelect.style.display = 'none';
    priceInput.style.display = 'block';
  });
  
  // 제품명 변경 시 상세정보 및 가격 자동 입력
  nameSelect.addEventListener('change', ()=>{
    // '기타' 선택 시 드롭다운을 입력 필드로 변경
    if(nameSelect.value === '기타') {
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.className = 'product-name';
      textInput.placeholder = '제품명을 직접 입력하세요';
      textInput.style.cssText = nameSelect.style.cssText;
      textInput.style.width = '100%';
      textInput.style.flex = '1';
      textInput.style.marginTop = '0';
      
      // 드롭다운을 입력 필드로 교체
      nameSelect.parentNode.replaceChild(textInput, nameSelect);
      
      // 상세정보와 가격 필드 초기화 (사용자가 직접 입력)
      detailInput.value = '';
      priceInput.value = '';
      priceSelect.style.display = 'none';
      priceInput.style.display = 'block';
      priceInput.removeAttribute('readonly');
      priceInput.removeAttribute('disabled');
      
      // 합계 필드 초기화
      totalInput.value = '';
      
      // 새로운 입력 필드에 이벤트 리스너 추가
      textInput.addEventListener('input', ()=>{
        updateProductTotal(qtyInput, priceInput, totalInput);
      });
      
      textInput.focus();
    } else {
      updateProductDetail(typeSelect, nameSelect, detailInput, priceInput, priceSelect);
      updateProductTotal(qtyInput, priceInput, totalInput);
    }
  });
  
  // 가격 선택 드롭다운 변경 시
  priceSelect.addEventListener('change', ()=>{
    console.log("가격 선택 드롭다운 변경됨:", priceSelect.value);
    priceInput.value = priceSelect.value;
    // 가격 선택 후 input 필드를 다시 표시하여 수정 가능하게 함
    priceSelect.style.display = 'none';
    priceInput.style.display = 'block';
    // 입력 필드가 편집 가능한지 확인
    priceInput.removeAttribute('readonly');
    priceInput.removeAttribute('disabled');
    priceInput.focus(); // 포커스를 주어 사용자가 바로 편집할 수 있도록 함
    updateProductTotal(qtyInput, priceInput, totalInput);
  });
  
  // 수량/가격 변경 시 합계 자동 계산
  qtyInput.addEventListener('input', ()=>updateProductTotal(qtyInput, priceInput, totalInput));
  priceInput.addEventListener('input', ()=>updateProductTotal(qtyInput, priceInput, totalInput));
  
  // 가격 입력 필드 클릭 시 편집 가능하도록 보장
  priceInput.addEventListener('click', ()=>{
    priceInput.removeAttribute('readonly');
    priceInput.removeAttribute('disabled');
    priceInput.focus();
  });
  
  // 가격 입력 필드 포커스 시 편집 가능하도록 보장
  priceInput.addEventListener('focus', ()=>{
    priceInput.removeAttribute('readonly');
    priceInput.removeAttribute('disabled');
  });
  
  // 비고 입력 제한
  noteInput.addEventListener('input', ()=>{ if(noteInput.value.length>20) noteInput.value=noteInput.value.slice(0,20); });

  updateGrandTotal();
}

// 제품 복제 함수
function duplicateLastProduct() {
  const productSets = document.querySelectorAll('.product-set');
  if(productSets.length === 0) {
    alert('복제할 제품이 없습니다.');
    return;
  }
  if(productCount >= maxProducts) {
    alert('최대 10개까지만 추가할 수 있습니다.');
    return;
  }
  
  // 마지막 제품 정보 가져오기
  const lastSet = productSets[productSets.length - 1];

  // 구분 필드가 input인지 select인지 확인 (직접입력 모드)
  const typeElement = lastSet.querySelector('.product-type') || lastSet.querySelector('.product-type-input');
  const isDirectInput = typeElement && typeElement.classList.contains('product-type-input');

  const lastData = {
    majorCategory: lastSet.querySelector('.product-major-category').value,
    type: typeElement ? typeElement.value : '',
    isDirectInput: isDirectInput,
    name: lastSet.querySelector('.product-name').tagName === 'INPUT' ?
          lastSet.querySelector('.product-name').value :
          lastSet.querySelector('.product-name').value,
    detail: lastSet.querySelector('.product-detail').value,
    qty: lastSet.querySelector('.product-qty').value,
    price: lastSet.querySelector('.product-price').value,
    note: lastSet.querySelector('.product-note').value,
    consumableValue: lastSet.querySelector('.consumable-option') ?
                    lastSet.querySelector('.consumable-option').value : null
  };
  
  // 새 제품 세트 추가
  addProductSet();
  
  // 방금 추가된 마지막 제품 세트에 데이터 입력
  const newSets = document.querySelectorAll('.product-set');
  const newSet = newSets[newSets.length - 1];
  
  // 대분류 선택
  const newMajorSelect = newSet.querySelector('.product-major-category');
  newMajorSelect.value = lastData.majorCategory;
  updateProductTypeOptions(newMajorSelect, newSet.querySelector('.product-type'));
  
  // 구분 선택
  setTimeout(() => {
    // 직접입력 모드인 경우
    if(lastData.isDirectInput) {
      const newTypeSelect = newSet.querySelector('.product-type');
      newTypeSelect.value = '직접입력';
      enableDirectInput(newTypeSelect);

      // 직접입력된 값 복원
      setTimeout(() => {
        const typeInput = newSet.querySelector('.product-type-input');
        if(typeInput) typeInput.value = lastData.type;

        const nameInput = newSet.querySelector('.product-name');
        if(nameInput) nameInput.value = lastData.name;

        const detailInput = newSet.querySelector('.product-detail');
        if(detailInput) detailInput.value = lastData.detail;

        const priceInput = newSet.querySelector('.product-price');
        if(priceInput) priceInput.value = lastData.price;

        newSet.querySelector('.product-qty').value = lastData.qty;
        newSet.querySelector('.product-note').value = lastData.note;
        updateProductTotal(newSet.querySelector('.product-qty'), newSet.querySelector('.product-price'), newSet.querySelector('.product-total'));
      }, 100);
      return;
    }

    // 일반 모드
    const newTypeSelect = newSet.querySelector('.product-type');
    newTypeSelect.value = lastData.type;
    updateProductNameOptions(newTypeSelect, newSet.querySelector('.product-name'), null);
    
    // 소모품인 경우 소모품 선택 드롭다운 설정
    if(lastData.type === "소모품" && lastData.consumableValue) {
      setTimeout(() => {
        const consumableSelect = newSet.querySelector('.consumable-option');
        if(consumableSelect) {
          consumableSelect.value = lastData.consumableValue;
          updateProductNameOptions(newTypeSelect, newSet.querySelector('.product-name'), consumableSelect);
          
          // 제품명 선택
          setTimeout(() => {
            const nameElement = newSet.querySelector('.product-name');
            if(nameElement.tagName === 'INPUT') {
              nameElement.value = lastData.name;
            } else {
              nameElement.value = lastData.name;
            }
            updateProductDetail(newTypeSelect, nameElement, newSet.querySelector('.product-detail'), 
                             newSet.querySelector('.product-price'), newSet.querySelector('.product-price-select'));
            
            // 나머지 정보 입력
            setTimeout(() => {
              newSet.querySelector('.product-qty').value = lastData.qty;
              newSet.querySelector('.product-note').value = lastData.note;
              updateProductTotal(newSet.querySelector('.product-qty'), newSet.querySelector('.product-price'), newSet.querySelector('.product-total'));
            }, 100);
          }, 100);
        }
      }, 100);
    } else {
      // 일반 제품인 경우
      setTimeout(() => {
        const nameElement = newSet.querySelector('.product-name');
        if(nameElement.tagName === 'INPUT') {
          nameElement.value = lastData.name;
        } else {
          nameElement.value = lastData.name;
        }
        updateProductDetail(newTypeSelect, nameElement, newSet.querySelector('.product-detail'), 
                         newSet.querySelector('.product-price'), newSet.querySelector('.product-price-select'));
        
        // 나머지 정보 입력
        setTimeout(() => {
          newSet.querySelector('.product-qty').value = lastData.qty;
          newSet.querySelector('.product-note').value = lastData.note;
          updateProductTotal(newSet.querySelector('.product-qty'), newSet.querySelector('.product-price'), newSet.querySelector('.product-total'));
        }, 100);
      }, 100);
    }
  }, 100);
}

document.getElementById('add-product').addEventListener('click', addProductSet);
document.getElementById('add-product-bottom').addEventListener('click', addProductSet);
document.getElementById('duplicate-product').addEventListener('click', duplicateLastProduct);
addProductSet(); // 최초 1개 세트 표시

// 담당자-연락처 매핑
const supplierContacts = {
  "이훈수": "hslee@bitekps.com / 010-3252-0593",
  "차재원": "cjw@bitekps.com / 010-5035-7791",
  "장진호": "jhjang@bitekps.com / 010-9999-4401",
  "하철용": "cyha@bitekps.com / 010-6206-7656",
  "노재익": "jake@bitekps.com / 010-6419-0945",
  "전준영": "methu78@bitekps.com / 010-2866-4914"
};

document.getElementById('supplier-person').addEventListener('change', function() {
  const selected = this.options[this.selectedIndex];
  // 연락처 자동 표시
  document.getElementById('supplier-email').value = selected.getAttribute('data-email') || '';
  document.getElementById('supplier-phone').value = selected.getAttribute('data-phone') || '';
  // 담당자ID 자동 표시
  document.getElementById('supplier-person-id').value = selected.getAttribute('data-id') || '';
});

// 견적번호 자동생성 함수 (개선버전)
async function autoFillEstimateNumber() {
  const dateVal = document.getElementById('date').value;
  const supplierSelect = document.getElementById('supplier-person');
  const supplierId = supplierSelect.options[supplierSelect.selectedIndex]?.getAttribute('data-id') || '';
  const numberInput = document.getElementById('number');
  
  if (!dateVal || !supplierId) return;

  // 날짜 YYMMDD 변환
  const yymmdd = dateVal.replace(/-/g, '').slice(2);
  
  // 로딩 표시
  numberInput.value = '생성중...';
  numberInput.style.color = '#999';
  
  let count = 1;
  
  try {
    console.log('견적번호 생성 시작...');
    
    // 5초 타임아웃 적용
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    const res = await fetch('https://auto-estimate.onrender.com/estimate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ check_only: true }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (res.ok) {
      const result = await res.json();
      if (result.pdf_count_today) count = result.pdf_count_today + 1;
      console.log('서버에서 카운트 가져옴:', count);
    } else {
      console.warn('API 응답 실패, 로컬 카운트 사용');
      count = getLocalCount(yymmdd, supplierId);
    }
    
  } catch (error) {
    console.error('API 호출 실패:', error.name);
    
    if (error.name === 'AbortError') {
      console.log('타임아웃으로 인한 로컬 카운트 사용');
    }
    
    // 백업: 로컬 스토리지 사용
    count = getLocalCount(yymmdd, supplierId);
  }

  // 견적번호 생성
  const estimateNumber = `DLP${yymmdd}-${supplierId}-${count}`;
  numberInput.value = estimateNumber;
  numberInput.style.color = '#000';
  
  // 로컬 카운트 저장
  saveLocalCount(yymmdd, supplierId, count);
  
  console.log('견적번호 생성 완료:', estimateNumber);
}

// 로컬 카운트 가져오기
function getLocalCount(yymmdd, supplierId) {
  const key = `count_${yymmdd}_${supplierId}`;
  const stored = localStorage.getItem(key);
  return stored ? parseInt(stored) + 1 : 1;
}

// 로컬 카운트 저장
function saveLocalCount(yymmdd, supplierId, count) {
  const key = `count_${yymmdd}_${supplierId}`;
  localStorage.setItem(key, count.toString());
}

// 견적일자, 담당자 변경 시 자동생성
document.getElementById('date').addEventListener('change', autoFillEstimateNumber);
document.getElementById('supplier-person').addEventListener('change', autoFillEstimateNumber);

function collectEstimateData() {
  const fileId = new URLSearchParams(window.location.search).get("id");
  return {
    estimate_date: document.getElementById('date').value,
    estimate_number: document.getElementById('number').value,
    supplier_person: document.getElementById('supplier-person').options[document.getElementById('supplier-person').selectedIndex].text,
    supplier_email: document.getElementById('supplier-email').value,
    supplier_phone: document.getElementById('supplier-phone').value,
    receiver_company: document.getElementById('receiver-company').value,
    receiver_person: document.getElementById('receiver-person').value,
    receiver_email: document.getElementById('receiver-email').value,
    receiver_phone: document.getElementById('receiver-phone').value,
    product_category: document.getElementById('product-category').value,
    quote_validity: document.getElementById('quote-validity').value,
    delivery_date: document.getElementById('delivery-date').value,
    product_training: document.getElementById('product-training').value,
    fileId: fileId, // fileId 추가
    products: Array.from(document.querySelectorAll('.product-set')).map(function(set) {
      // 제품명 필드가 input인지 select인지 확인
      const nameElement = set.querySelector('.product-name');
      const productName = nameElement.tagName === 'INPUT' ? nameElement.value : nameElement.value;

      // 구분 필드가 input인지 select인지 확인 (직접입력 모드)
      const typeElement = set.querySelector('.product-type') || set.querySelector('.product-type-input');
      const productType = typeElement ? typeElement.value : '';

      return {
        major_category: set.querySelector('.product-major-category').value,
        type: productType,
        name: productName,
        detail: set.querySelector('.product-detail').value,
        qty: Number(set.querySelector('.product-qty').value),
        price: Number(set.querySelector('.product-price').value.replace(/,/g, "") || 0),
        total: Number(set.querySelector('.product-total').value.replace(/,/g, "")),
        note: set.querySelector('.product-note').value
      };
    })
  };
}

function validateEstimateForm() {
  console.log("=== 견적서 유효성 검사 시작 ===");
  
  // 필수 입력값 체크
  const date = document.getElementById('date').value;
  const number = document.getElementById('number').value;
  const supplierPerson = document.getElementById('supplier-person').value;
  const receiverCompany = document.getElementById('receiver-company').value;
  const productCategory = document.getElementById('product-category').value;
  const deliveryDate = document.getElementById('delivery-date').value;
  
  console.log("입력값 확인:");
  console.log("- 견적일자:", date);
  console.log("- 견적번호:", number);
  console.log("- 공급자 담당자:", supplierPerson);
  console.log("- 수신자 회사명:", receiverCompany);
  console.log("- 견적제품:", productCategory);
  console.log("- 납기일:", deliveryDate);
  
  if (!date) {
    console.log("❌ 견적일자 누락");
    alert('견적일자를 입력해 주세요.');
    return false;
  }
  if (!number) {
    console.log("❌ 견적번호 누락");
    alert('견적번호를 입력해 주세요.');
    return false;
  }
  if (!supplierPerson) {
    console.log("❌ 공급자 담당자 누락");
    alert('공급자 담당자를 선택해 주세요.');
    return false;
  }
  if (!receiverCompany) {
    console.log("❌ 수신자 회사명 누락");
    alert('수신자 회사명을 입력해 주세요.');
    return false;
  }
  // 견적제품 선택 필수
  if (!productCategory) {
    console.log("❌ 견적제품 누락");
    alert('견적제품을 선택해 주세요.');
    return false;
  }
  // 제품정보 필수값 체크 (비고 제외)
  const sets = document.querySelectorAll('.product-set');
  if (sets.length === 0) {
    alert('제품정보를 1개 이상 입력해 주세요.');
    return false;
  }
  for (let i = 0; i < sets.length; i++) {
    const set = sets[i];
    const majorCategory = set.querySelector('.product-major-category').value;

    // 구분 필드가 input인지 select인지 확인 (직접입력 모드)
    const typeElement = set.querySelector('.product-type') || set.querySelector('.product-type-input');
    const type = typeElement ? typeElement.value : '';

    const nameElement = set.querySelector('.product-name');
    const name = nameElement.tagName === 'INPUT' ? nameElement.value : nameElement.value;
    const detail = set.querySelector('.product-detail').value;
    const qty = set.querySelector('.product-qty').value;
    const price = set.querySelector('.product-price').value;
    const total = set.querySelector('.product-total').value;
    if (!majorCategory) {
      alert(`제품 ${i+1}의 대분류를 선택해 주세요.`);
      return false;
    }
    if (!type) {
      alert(`제품 ${i+1}의 구분을 입력해 주세요.`);
      return false;
    }
    if (!name) {
      alert(`제품 ${i+1}의 제품명을 입력해 주세요.`);
      return false;
    }
    if (!detail) {
      alert(`제품 ${i+1}의 상세정보를 입력해 주세요.`);
      return false;
    }
    if (!qty) {
      alert(`제품 ${i+1}의 수량을 입력해 주세요.`);
      return false;
    }
    if (!price && price !== 0) {
      alert(`제품 ${i+1}의 공급단가를 입력해 주세요.`);
      return false;
    }
    if (!total) {
      alert(`제품 ${i+1}의 합계를 입력해 주세요.`);
      return false;
    }
  }
  // 납기일 필수
  if (!deliveryDate) {
    console.log("❌ 납기일 누락");
    alert('납기일을 입력해 주세요.');
    return false;
  }
  
  // 제품교육 필수
  const productTraining = document.getElementById('product-training').value;
  if (!productTraining) {
    console.log("❌ 제품교육 누락");
    alert('제품교육을 선택해 주세요.');
    return false;
  }
  
  console.log("✅ 모든 필수 입력값 검증 완료");
  return true;
}

async function sendEstimateToFastAPI() {
  console.log("=== 견적서 생성 시작 ===");
  
  if (!validateEstimateForm()) {
    console.log("❌ 유효성 검사 실패");
    return;
  }
  
  console.log("✅ 유효성 검사 통과");
  
  const button = document.getElementById('preview-btn');
  const originalText = button.textContent;
  
  try {
    // 버튼 비활성화 및 로딩 애니메이션 적용
    button.disabled = true;
    button.classList.add('loading');
    button.textContent = '처리 중...';
    
    // 즉시 시각적 피드백을 위한 약간의 지연
    await new Promise(resolve => setTimeout(resolve, 50));
    
    const data = collectEstimateData();
    let fileId = new URLSearchParams(window.location.search).get("id");
    
    // fileId가 없거나 템플릿 변수인 경우 새로운 견적서 템플릿 생성
    if (!fileId || fileId === "{{24.id}}" || fileId.includes("{{") || fileId.includes("}}")) {
      console.log("fileId가 없거나 템플릿 변수입니다. 새로운 템플릿을 생성합니다.");
    } else {
      console.log("유효한 fileId가 이미 제공되었습니다:", fileId);
      data.fileId = fileId;
    }
    
    // fileId가 없는 경우에만 템플릿 생성
    if (!fileId || fileId === "{{24.id}}" || fileId.includes("{{") || fileId.includes("}}")) {
      console.log("새로운 견적서 템플릿 생성 시작");
      console.log("현재 fileId:", fileId);
      console.log("fileId 검증:", {
        isEmpty: !fileId,
        isTemplateVar: fileId === "{{24.id}}",
        containsTemplate: fileId && (fileId.includes("{{") || fileId.includes("}}"))
      });
      
      try {
        console.log("견적서 템플릿 복사 API 호출 중...");
        // 견적서 템플릿 복사 API 호출
        const templateResponse = await fetch('https://auto-estimate.onrender.com/create-estimate-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log("API 응답 상태:", templateResponse.status);
        const templateResult = await templateResponse.json();
        console.log("API 응답 결과:", templateResult);
        
        if (templateResult.status === "success") {
          console.log("견적서 템플릿 생성 성공:", templateResult);
          fileId = templateResult.file_id; // fileId 변수 업데이트
          data.fileId = fileId;
          
          // URL에 fileId 추가
          const newUrl = new URL(window.location);
          newUrl.searchParams.set('id', fileId);
          window.history.replaceState({}, '', newUrl);
          console.log("URL 업데이트 완료:", newUrl.toString());
        } else {
          console.error("견적서 템플릿 생성 실패:", templateResult);
          alert("견적서 템플릿 생성에 실패했습니다: " + templateResult.message);
          return;
        }
      } catch (error) {
        console.error("견적서 템플릿 생성 중 오류:", error);
        alert("견적서 템플릿 생성 중 오류가 발생했습니다.");
        return;
      }
    } else {
      console.log("기존 fileId 사용:", fileId);
      data.fileId = fileId;
    }

    // 견적제품 선택 값 저장
    const productCategory = document.getElementById('product-category').value;

    // 안전하게 storage에 저장 (localStorage와 sessionStorage 모두 시도)
    try {
      localStorage.setItem('productCategory', productCategory);
      sessionStorage.setItem('productCategory', productCategory);
    } catch (e) {
      console.warn('Storage 저장 실패:', e);
    }

    // 최소 로딩 시간 설정 (너무 빨리 넘어가는 것 방지)
    const startTime = Date.now();
    const minLoadingTime = 1500; // 최소 1.5초 로딩

    button.textContent = '견적서 생성 중...';

    console.log("견적서 생성 API 호출 전 데이터:", data);
    console.log("사용할 fileId:", fileId);

    const response = await fetch('https://auto-estimate.onrender.com/estimate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    console.log("견적서 생성 API 응답:", result);

    button.textContent = '완료 중...';

    if(result.status === "success") {
      // 최소 로딩 시간 보장
      const elapsedTime = Date.now() - startTime;
      const remainingTime = Math.max(0, minLoadingTime - elapsedTime);

      setTimeout(() => {
        // 데이터 저장 (localStorage와 sessionStorage 모두 시도)
        const dataToStore = JSON.stringify(data);
        console.log('저장할 데이터:', dataToStore);

        try {
          localStorage.setItem('estimateData', dataToStore);
          sessionStorage.setItem('estimateData', dataToStore);
          console.log('Storage 저장 완료');
        } catch (e) {
          console.warn('Storage 저장 실패:', e);
          console.warn('localStorage 사용 불가 - 시크릿 모드이거나 저장 공간이 부족합니다.');
        }

        console.log('preview.html로 이동할 fileId:', fileId);

        // fileId를 URL에 포함하여 preview.html로 이동
        if (fileId) {
          window.location.href = `preview.html?id=${fileId}`;
        } else {
          window.location.href = `preview.html`;
        }
      }, remainingTime);
    } else {
      alert('전송 실패! 다시 시도해 주세요.');
    }
  } catch (error) {
    console.error('견적서 생성 중 오류:', error);
    alert('전송 중 오류가 발생했습니다.');
  } finally {
    // 버튼 상태 복원
    button.disabled = false;
    button.classList.remove('loading');
    button.textContent = originalText;
  }
}

document.getElementById('preview-btn').addEventListener('click', sendEstimateToFastAPI);

// 페이지 로드 시 fileId 상태 확인 및 데이터 복원
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const fileId = urlParams.get("id");
  
  console.log("=== 페이지 로드 및 데이터 복원 시작 ===");

  // 1. localStorage 또는 sessionStorage에서 데이터 확인
  let existingData = null;
  try {
    existingData = localStorage.getItem('estimateData');
    if (!existingData) {
      existingData = sessionStorage.getItem('estimateData');
      console.log('localStorage에 데이터가 없어 sessionStorage에서 복원 시도');
    }
  } catch (e) {
    console.warn('Storage 접근 실패:', e);
    try {
      existingData = sessionStorage.getItem('estimateData');
    } catch (e2) {
      console.error('sessionStorage 접근도 실패:', e2);
    }
  }

  if (existingData) {
    try {
      const data = JSON.parse(existingData);
      console.log("복원할 데이터 발견:", data);

      // fileId가 URL에 없고 저장된 데이터에만 있는 경우 (뒤로가기 등)
      // 현재 URL의 id 파라미터가 우선순위가 높음
      if (!fileId && data.fileId) {
        console.log("URL에 ID가 없어 저장된 ID 사용:", data.fileId);
      }

      restoreFormData(data);

    } catch (e) {
      console.error("데이터 복원 중 오류:", e);
    }
  } else {
    console.log("복원할 데이터가 없습니다.");
    // 데이터가 없으면 기본으로 제품 1개는 addProductSet()이 아래에서 호출됨 (기존 코드)
  }
});

// 폼 데이터 복원 함수
function restoreFormData(data) {
  // 1. 기본 필드 복원
  if(data.estimate_date) document.getElementById('date').value = data.estimate_date;
  if(data.estimate_number) document.getElementById('number').value = data.estimate_number;
  if(data.receiver_company) document.getElementById('receiver-company').value = data.receiver_company;
  if(data.receiver_person) document.getElementById('receiver-person').value = data.receiver_person;
  if(data.receiver_email) document.getElementById('receiver-email').value = data.receiver_email;
  if(data.receiver_phone) document.getElementById('receiver-phone').value = data.receiver_phone;
  if(data.quote_validity) document.getElementById('quote-validity').value = data.quote_validity;
  if(data.delivery_date) document.getElementById('delivery-date').value = data.delivery_date;
  
  // 2. 공급자 담당자 선택 및 이벤트 트리거
  if(data.supplier_person) {
    const supplierSelect = document.getElementById('supplier-person');
    // 텍스트로 옵션 찾기
    for(let i=0; i<supplierSelect.options.length; i++) {
        if(supplierSelect.options[i].text === data.supplier_person) {
            supplierSelect.selectedIndex = i;
            // change 이벤트 수동 트리거 (이메일/전화번호 자동채움)
            supplierSelect.dispatchEvent(new Event('change'));
            break;
        }
    }
  }
  
  // 3. 견적제품 선택
  if(data.product_category) {
    document.getElementById('product-category').value = data.product_category;
  }
  
  // 4. 제품교육 (드롭다운 or 텍스트)
  if(data.product_training) {
    const trainingSelect = document.getElementById('product-training');
    let matchFound = false;
    for(let i=0; i<trainingSelect.options.length; i++) {
        if(trainingSelect.options[i].value === data.product_training) {
            trainingSelect.selectedIndex = i;
            matchFound = true;
            break;
        }
    }
    
    // 드롭다운에 없는 값이면 (사용자 직접 입력) 텍스트 필드로 변환
    if(!matchFound) {
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.id = 'product-training';
        textInput.value = data.product_training;
        textInput.style.cssText = trainingSelect.style.cssText;
        textInput.style.width = '100%';
        textInput.style.padding = '8px';
        textInput.style.border = '1px solid #ddd';
        textInput.style.borderRadius = '4px';
        
        trainingSelect.parentNode.replaceChild(textInput, trainingSelect);
    }
  }
  
  // 5. 제품 목록 복원
  if (data.products && data.products.length > 0) {
    // 기존 제품 영역 초기화 (기본 추가된 1개 제거)
    document.getElementById('products-area').innerHTML = '';
    productCount = 0;
    setAddProductButtonsDisabled(false);
    
    data.products.forEach((prod, index) => {
      addProductSet(); // 빈 세트 추가
      
      // 방금 추가된 세트 찾기
      const sets = document.querySelectorAll('.product-set');
      const set = sets[sets.length - 1];
      
      const majorSelect = set.querySelector('.product-major-category');
      const typeSelect = set.querySelector('.product-type');
      const nameSelect = set.querySelector('.product-name');
      const detailInput = set.querySelector('.product-detail');
      const qtyInput = set.querySelector('.product-qty');
      const priceInput = set.querySelector('.product-price');
      const totalInput = set.querySelector('.product-total');
      const noteInput = set.querySelector('.product-note');
      
      // 대분류 설정
      majorSelect.value = prod.major_category;
      updateProductTypeOptions(majorSelect, typeSelect);
      
      // 구분 설정 (직접입력 체크)
      // productData에 해당 구분이 있으면 일반, 없으면 직접입력 간주
      const isDirectType = !majorCategories[prod.major_category] || !majorCategories[prod.major_category].includes(prod.type);
      
      if (prod.type === '직접입력') { // 명시적 '직접입력'
         typeSelect.value = '직접입력';
         enableDirectInput(typeSelect);
         const typeInput = set.querySelector('.product-type-input');
         if(typeInput) typeInput.value = prod.type; 
      } else {
         // 드롭다운에 값이 있는지 확인
         let typeOptionExists = false;
         for(let i=0; i<typeSelect.options.length; i++){
             if(typeSelect.options[i].value === prod.type) {
                 typeOptionExists = true;
                 break;
             }
         }
         
         if(typeOptionExists) {
             typeSelect.value = prod.type;
             updateProductNameOptions(typeSelect, nameSelect, null);
         } else {
             // 옵션에 없으면 직접입력으로 처리
             const directOpt = document.createElement('option');
             directOpt.value = '직접입력'; 
             // 위에서 createProductSet시 이미 추가되지만 확실히 하기 위해
             typeSelect.value = '직접입력'; 
             enableDirectInput(typeSelect);
             const typeInput = set.querySelector('.product-type-input');
             if(typeInput) typeInput.value = prod.type;
         }
      }

      // 제품명 설정
      // 앞서 updateProductNameOptions가 호출되었음.
      // 소모품 처리
      if (prod.type === '소모품') {
          // 어떤 소모품 장비인지 찾아야 함.
          // prod.name이 consumableData의 어느 키 배열에 있는지 역추적하거나,
          // 저장된 데이터에 consumableValue가 없으므로 (collectEstimateData에 누락됨)
          // 이름으로 추론해야 함.
          
          // 하지만 여기선 단순히 이름이 일치하는 옵션을 찾거나 없으면 직접입력 처리
          // 소모품의 경우 typeSelect 옆에 consumable-option이 생김
          const consumableSelect = set.querySelector('.consumable-option');
          if(consumableSelect) {
             // 소모품 장비 모델을 알 수 없으므로(저장 안함), 
             // 모든 소모품 데이터를 뒤져서 일치하는 이름이 있는지 확인
             let foundModel = '';
             for(const [model, items] of Object.entries(consumableData)) {
                 if(items.some(item => item.name === prod.name)) {
                     foundModel = model;
                     break;
                 }
             }
             if(foundModel) {
                 consumableSelect.value = foundModel;
                 // 모델 선택 이벤트 트리거와 유사하게 동작
                 updateProductNameOptions(typeSelect, nameSelect, consumableSelect);
             }
          }
      }
      
      // 제품명 값 설정
      // 현재 nameSelect가 select인지 input인지 확인
      const currentNameEl = set.querySelector('.product-name');
      
      // 만약 drop down에 해당 이름이 없으면 '기타' -> 직접입력 전환 또는 바로 inputValue설정
      if(currentNameEl.tagName === 'SELECT') {
          let nameExists = false;
          for(let i=0; i<currentNameEl.options.length; i++) {
              if(currentNameEl.options[i].value === prod.name) {
                  nameExists = true;
                  break;
              }
          }
          
          if(nameExists) {
              currentNameEl.value = prod.name;
              // 가격 옵션 등 업데이트 (단, 아래에서 값을 덮어쓸 것이므로 중요도는 낮음)
              // updateProductDetail(...) 호출하면 detail/price가 리셋될 수 있으므로 주의.
              // 여기서는 그냥 값만 force setting하고 detail/price는 저장된 값으로 덮어쓰기
          } else {
              // 리스트에 없으면 '기타' 처리 (직접입력)
              // 혹은 원래 '직접입력' 모드였을 수 있음
              
              // 강제로 input으로 변환
              const textInput = document.createElement('input');
              textInput.type = 'text';
              textInput.className = 'product-name';
              textInput.style.cssText = currentNameEl.style.cssText;
              textInput.value = prod.name;
              currentNameEl.parentNode.replaceChild(textInput, currentNameEl);
          }
      } else {
          currentNameEl.value = prod.name;
      }
      
      // 상세정보, 수량, 가격, 비고 복원
      detailInput.value = prod.detail;
      qtyInput.value = prod.qty;
      priceInput.value = prod.price; // 숫자형이어도 input엔 잘 들어감
      totalInput.value = prod.total.toLocaleString(); // 콤마 포맷
      noteInput.value = prod.note;
      
      // 가격 드롭다운 처리 (저장된 가격과 일치하는게 있으면 숨김/보임 처리 등)
      // 그냥 input에 값을 넣었으므로 select는 숨김 처리
      const priceSelect = set.querySelector('.product-price-select');
      if(priceSelect) priceSelect.style.display = 'none';
      priceInput.style.display = 'block';
      
    });
    updateGrandTotal();
  }
}

// 제품교육 드롭다운 선택 후 텍스트 입력 필드로 변환
document.addEventListener('DOMContentLoaded', function() {
  const productTrainingSelect = document.getElementById('product-training');
  
  productTrainingSelect.addEventListener('change', function() {
    if (this.value && this.value !== '') {
      // 선택된 값을 가져옴
      const selectedValue = this.value;
      
      // 새로운 텍스트 입력 필드 생성
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.id = 'product-training';
      textInput.value = selectedValue;
      textInput.style.cssText = this.style.cssText; // 기존 스타일 복사
      textInput.style.width = '100%';
      textInput.style.padding = '8px';
      textInput.style.border = '1px solid #ddd';
      textInput.style.borderRadius = '4px';
      textInput.placeholder = '제품교육 내용을 입력하거나 수정하세요';
      
      // 부모 요소에서 드롭다운 제거하고 텍스트 입력 필드 추가
      const parent = this.parentNode;
      parent.removeChild(this);
      parent.appendChild(textInput);
      
      // 텍스트 입력 필드에 포커스
      textInput.focus();
    }
  });
});

</script>
</body>
</html>
