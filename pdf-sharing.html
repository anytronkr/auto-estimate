<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PDF ë¯¸ë¦¬ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Pretendard', 'Noto Sans KR', Arial, sans-serif; background: #f8f8f8; margin: 0; }
    .container { max-width: 100%; width: 100%; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px #eee; padding: 16px; box-sizing: border-box; }
    h2 { color: #21808c; text-align: center; margin-bottom: 24px; font-size: 1.5em; }
    .pdf-viewer { width: 100%; height: 60vh; min-height: 400px; border: 1px solid #ccc; border-radius: 8px; }
    .share-btn { 
      margin-top: 20px; 
      display: block; 
      width: 100%; 
      padding: 14px; 
      background: #1cc7b6; 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      font-size: 1em; 
      cursor: pointer;
      transition: background-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .share-btn:active {
      background: #189a8c;
      transform: scale(0.98);
    }
    .action-btns {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 18px;
    }
    .action-btns button {
      width: 100%;
      padding: 13px;
      background: #f5f5f5;
      color: #21808c;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .action-btns button:hover {
      background: #21808c;
      color: #fff;
    }
    @media (max-width: 600px) {
      .container { 
        padding: 12px; 
        border-radius: 0; 
        box-shadow: none; 
        margin: 0;
        max-width: 100%;
      }
      h2 { 
        font-size: 1.2em; 
        margin-bottom: 16px; 
        color: #21808c;
      }
      .pdf-viewer { 
        min-height: 300px; 
        height: 50vh; 
        border-radius: 6px;
      }
      .share-btn { 
        padding: 14px; 
        font-size: 1em; 
        font-weight: 500;
        margin-bottom: 8px;
      }
      .action-btns { 
        gap: 8px; 
        margin-top: 16px; 
      }
      .action-btns button { 
        padding: 12px; 
        font-size: 0.95em; 
        font-weight: 500;
      }
      /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ê°„ê²© ì¡°ì • */
      .share-btn[style*="margin-top"] {
        margin-top: 8px !important;
      }
    }
    
    /* ë§¤ìš° ì‘ì€ í™”ë©´ (320px ì´í•˜) */
    @media (max-width: 320px) {
      .container { padding: 8px; }
      h2 { font-size: 1.1em; }
      .pdf-viewer { min-height: 250px; height: 45vh; }
      .share-btn { padding: 12px; font-size: 0.9em; }
      .action-btns button { padding: 10px; font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PDF ë¯¸ë¦¬ë³´ê¸°</h2>
    <iframe id="pdf-frame" class="pdf-viewer" src="" allow="autoplay" onload="handlePdfLoad()" onerror="handlePdfError()"></iframe>
    <div id="pdf-error" style="display: none; text-align: center; padding: 40px; color: #666;">
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
      <h3>PDF ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>PDF íŒŒì¼ì€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ í†µí•´ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <button class="share-btn" onclick="downloadPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
    <button class="share-btn" onclick="sharePDF()" style="margin-top: 10px; background: #21808c;">PDF ê³µìœ í•˜ê¸°</button>
    <button class="share-btn" onclick="openInGoogleDrive()" style="margin-top: 10px; background: #34a853;">
      <i class="fas fa-external-link-alt"></i>
      PDF íŒŒì¼ êµ¬ê¸€ë“œë¼ì´ë¸Œì—ì„œ ë³´ê¸°
    </button>
    <div class="action-btns">
      <button onclick="goBack()">í¸ì§‘í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button onclick="goHome()">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button onclick="goDrive()">êµ¬ê¸€ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸°</button>
    </div>
  </div>
  <script>
    // URLì—ì„œ id íŒŒë¼ë¯¸í„°ë¡œ PDF íŒŒì¼ IDë¥¼ ë°›ìŒ
    const urlParams = new URLSearchParams(window.location.search);
    const pdfId = urlParams.get('id'); // êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ID
    const fileId = urlParams.get('fileId'); // ê²¬ì ì„œ íŒŒì¼ ID
    
    let fallbackAttempted = false;

    // êµ¬ê¸€ ë“œë¼ì´ë¸Œ PDF ë¯¸ë¦¬ë³´ê¸° ë§í¬ ìƒì„± (ë” ì•ˆì •ì ì¸ ë°©ë²•)
    if (pdfId) {
      // ë°©ë²• 1: Google Drive ì§ì ‘ ë·°ì–´ ì‚¬ìš©
      const pdfUrl = `https://drive.google.com/file/d/${pdfId}/preview`;
      document.getElementById('pdf-frame').src = pdfUrl;
      console.log('PDF ë¯¸ë¦¬ë³´ê¸° URL:', pdfUrl);
    } else {
      document.getElementById('pdf-frame').src = '';
    }
    
    // PDF ë¡œë“œ ì„±ê³µ ì²˜ë¦¬
    function handlePdfLoad() {
      console.log('PDF ë¡œë“œ ì„±ê³µ');
      document.getElementById('pdf-error').style.display = 'none';
      document.getElementById('pdf-frame').style.display = 'block';
    }
    
    // PDF ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
    function handlePdfError() {
      console.log('PDF ë¡œë“œ ì‹¤íŒ¨');
      if (!fallbackAttempted) {
        fallbackAttempted = true;
        // ë°©ë²• 2: Google Docs Viewerë¡œ ì¬ì‹œë„
        const iframe = document.getElementById('pdf-frame');
        iframe.src = `https://docs.google.com/viewer?url=https://drive.google.com/uc?export=download&id=${pdfId}&embedded=true`;
        console.log('Fallback 1 ì‹œë„: Google Docs Viewer');
      } else {
        // ë°©ë²• 3: ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ë¡œ ì¬ì‹œë„
        const iframe = document.getElementById('pdf-frame');
        iframe.src = `https://drive.google.com/uc?export=view&id=${pdfId}`;
        console.log('Fallback 2 ì‹œë„: ì§ì ‘ ë·°ì–´');
        
        // 3ì´ˆ í›„ì—ë„ ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        setTimeout(() => {
          if (document.getElementById('pdf-frame').style.display !== 'none') {
            document.getElementById('pdf-frame').style.display = 'none';
            document.getElementById('pdf-error').style.display = 'block';
            console.log('ëª¨ë“  ë¯¸ë¦¬ë³´ê¸° ë°©ë²• ì‹¤íŒ¨, ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ');
          }
        }, 3000);
      }
    }

    // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadPDF() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
      const directDownloadUrl = `https://drive.google.com/uc?export=download&id=${pdfId}`;
      
      // ìƒˆ ì°½ì—ì„œ PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ì—´ê¸°
      const downloadWindow = window.open(directDownloadUrl, '_blank');
      
      if (downloadWindow) {
        // ìƒˆ ì°½ì´ ì—´ë ¸ìœ¼ë©´ ì ì‹œ í›„ ë‹«ê¸° (ì„ íƒì‚¬í•­)
        setTimeout(() => {
          downloadWindow.close();
        }, 2000);
      }
    }

    // ê³µìœ  ë²„íŠ¼ - ì—¬ëŸ¬ ê³µìœ  ì˜µì…˜ í‘œì‹œ
    function sharePDF() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ëª¨ë°”ì¼ì—ì„œëŠ” ì§ì ‘ ê³µìœ  ì˜µì…˜ë“¤ì„ í‘œì‹œ
      if (navigator.share) {
        // ë„¤ì´í‹°ë¸Œ ê³µìœ  ë©”ë‰´ í‘œì‹œ
        showShareOptions();
      } else {
        // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ë§í¬ ë³µì‚¬
        const directDownloadUrl = `https://drive.google.com/uc?export=download&id=${pdfId}`;
        copyToClipboard(directDownloadUrl);
      }
    }

    // ê³µìœ  ì˜µì…˜ ë©”ë‰´ í‘œì‹œ
    function showShareOptions() {
      const shareOptions = [
        { 
          name: 'ì´ë©”ì¼ë¡œ ê³µìœ ', 
          action: () => shareViaEmail(),
          icon: 'ğŸ“§'
        },
        { 
          name: 'ë§í¬ ê³µìœ ', 
          action: () => sharePDFLink(),
          icon: 'ğŸ”—'
        },
        { 
          name: 'ë‹¤ìš´ë¡œë“œ í›„ ê³µìœ ', 
          action: () => downloadAndShare(),
          icon: 'ğŸ“±'
        }
      ];

      // ê°„ë‹¨í•œ ì„ íƒ ë©”ë‰´ í‘œì‹œ
      const choice = confirm('PDFë¥¼ ì–´ë–»ê²Œ ê³µìœ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ì´ë©”ì¼ë¡œ ê³µìœ \nì·¨ì†Œ: ë§í¬ ë³µì‚¬');
      
      if (choice) {
        shareViaEmail();
      } else {
        sharePDFLink();
      }
    }

    // ë§í¬ë¡œë§Œ ê³µìœ 
    async function sharePDFLink() {
      const directDownloadUrl = `https://drive.google.com/uc?export=download&id=${pdfId}`;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'ê²¬ì ì„œ PDF',
            text: 'ê²¬ì ì„œ PDF íŒŒì¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.',
            url: directDownloadUrl
          });
        } catch (error) {
          console.log('ë§í¬ ê³µìœ  ì‹¤íŒ¨:', error);
          copyToClipboard(directDownloadUrl);
        }
      } else {
        copyToClipboard(directDownloadUrl);
      }
    }

    // ë‹¤ìš´ë¡œë“œ í›„ ê³µìœ 
    function downloadAndShare() {
      // PDF ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      downloadPDF();
      
      // ì•ˆë‚´ ë©”ì‹œì§€
      setTimeout(() => {
        alert('PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ì´ë©”ì¼ì´ë‚˜ ë©”ì‹ ì €ì— ì§ì ‘ ì²¨ë¶€í•´ ì£¼ì„¸ìš”.');
      }, 1000);
    }

    // ì´ë©”ì¼ë¡œ PDF ê³µìœ  - ê²¬ì ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ë©”ì¼ ë‚´ìš© ìë™ ì±„ìš°ê¸°
    function shareViaEmail() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ê²¬ì ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      let estimateData = {};
      try {
        // localStorageì—ì„œ ê²¬ì ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const storedData = localStorage.getItem('estimateData');
        if (storedData) {
          estimateData = JSON.parse(storedData);
          console.log('ê²¬ì ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', estimateData);
        } else {
          console.log('localStorageì— ê²¬ì ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (e) {
        console.error('ê²¬ì ì„œ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
      }

      // ìˆ˜ì‹ ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (XSS ë°©ì§€ë¥¼ ìœ„í•´ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ)
      const receiverCompany = (estimateData.receiver_company || '[ìˆ˜ì‹ ì-íšŒì‚¬ëª…]').toString().trim();
      const receiverPerson = (estimateData.receiver_person || '[ìˆ˜ì‹ ì-ë‹´ë‹¹ì]').toString().trim();
      const receiverEmail = (estimateData.receiver_email || '').toString().trim();
      
      // ë°›ëŠ” ì‚¬ëŒ í‘œì‹œìš© ì´ë¦„ (íšŒì‚¬ëª…_ë‹´ë‹¹ìëª… í˜•ì‹)
      const receiverDisplayName = `${receiverCompany}_${receiverPerson}`;

      // ë©”ì¼ ì œëª©
      const subject = '[ì• ë‹ˆíŠ¸ë¡ ]ê²¬ì ì„œ ì†¡ë¶€ ë“œë¦½ë‹ˆë‹¤.';

      // ë©”ì¼ ë‚´ìš© (ê²¬ì ì„œ ë°ì´í„°ë¡œ ìë™ ì±„ìš°ê¸°)
      let pdfDownloadLink = '';
      if (pdfId) {
        pdfDownloadLink = `https://drive.google.com/file/d/${pdfId}/view?usp=sharing`;
      } else {
        pdfDownloadLink = 'êµ¬ê¸€ë“œë¼ì´ë¸Œì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      }
      
      // í…œí”Œë¦¿ ë¬¸ìì—´ë¡œ ì‘ì„± í›„ encodeURIComponentë¡œ ì²˜ë¦¬ (ì¤„ë°”ê¿ˆ í˜¸í™˜ì„± í–¥ìƒ)
      const body = `ì•ˆë…•í•˜ì„¸ìš”. ${receiverCompany} ${receiverPerson}ë‹˜,

ìš”ì²­í•˜ì‹  ì œí’ˆì— ëŒ€í•œ ê²¬ì ì„œë¥¼ ì²¨ë¶€ë“œë¦½ë‹ˆë‹¤.

â–  ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ
ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì‹œë©´ PDF ê²¬ì ì„œë¥¼ ë°”ë¡œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
â–¶ PDF ê²¬ì ì„œ ë°”ë¡œê°€ê¸°: ${pdfDownloadLink}

â€» ë§í¬ê°€ í´ë¦­ë˜ì§€ ì•ŠëŠ” ê²½ìš°, ìœ„ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.

ì²¨ë¶€ëœ ê²¬ì ì„œë¥¼ í™•ì¸í•˜ì‹œê³ , ì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ìˆ˜ì • ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`;

      // ìˆ˜ì‹ ì ì´ë©”ì¼ì´ ìˆìœ¼ë©´ ë°›ëŠ” ì‚¬ëŒìœ¼ë¡œ ì„¤ì •, ì—†ìœ¼ë©´ ì£¼ì†Œ ì—†ì´ ì—´ê¸°
      let mailtoLink = '';
      if (receiverEmail && receiverEmail.length > 0) {
        // ë°›ëŠ” ì‚¬ëŒ ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ëª¨ë‘ ì„¤ì • (name íŒŒë¼ë¯¸í„° ì¶”ê°€)
        mailtoLink = `mailto:${encodeURIComponent(receiverDisplayName)} <${receiverEmail}>?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      } else {
        mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      }

      // ë©”ì¼ ì•± ì—´ê¸° (iOS í˜¸í™˜ì„± ìœ ì§€)
      window.location.href = mailtoLink;
      
      // ë™ì‹œì— PDF ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      setTimeout(() => {
        downloadPDF();
        
        // ì•ˆë‚´ ë©”ì‹œì§€
        setTimeout(() => {
          alert('ë©”ì¼ ì•±ì´ ì—´ë¦¬ê³  PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìš´ë¡œë“œëœ PDF íŒŒì¼ì„ ë©”ì¼ì— ì²¨ë¶€í•´ ì£¼ì„¸ìš”.');
        }, 1500);
      }, 500);
    }

    // í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          alert('PDF ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në§í¬: ' + text);
        }).catch(() => {
          // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë³µì‚¬
          manualCopy(text);
        });
      } else {
        // êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›
        manualCopy(text);
      }
    }

    // ìˆ˜ë™ ë³µì‚¬ í•¨ìˆ˜ (êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›)
    function manualCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('PDF ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në§í¬: ' + text);
      } catch (err) {
        alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n\n' + text);
      }
      document.body.removeChild(textArea);
    }

    function goBack() {
      // history.back()ì„ ì‚¬ìš©í•˜ì—¬ ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
      // ì´ë ‡ê²Œ í•˜ë©´ localStorage ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
      history.back();
    }
    function goHome() {
      // í™ˆìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ ì´ì „ ê²¬ì  ë°ì´í„° ì´ˆê¸°í™”
      localStorage.removeItem('estimateData');
      localStorage.removeItem('productCategory');
      window.location.href = 'https://auto-estimate.onrender.com';
    }
    function goDrive() {
      window.open('https://drive.google.com/drive/folders/1aRR0m61B_a4B6ag76GrYt-8bdxiyYRC6?usp=sharing', '_blank');
    }

    // PDF íŒŒì¼ì„ Google Driveì—ì„œ ì§ì ‘ ë³´ê¸°
    function openInGoogleDrive() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // Google Driveì—ì„œ PDF íŒŒì¼ ì§ì ‘ ë³´ê¸° ë§í¬ ìƒì„±
      const driveViewUrl = `https://drive.google.com/file/d/${pdfId}/view?usp=sharing`;
      
      // ìƒˆ ì°½ì—ì„œ Google Drive ë·°ì–´ ì—´ê¸°
      window.open(driveViewUrl, '_blank');
    }
  </script>
</body>
</html>
