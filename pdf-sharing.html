<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PDF ë¯¸ë¦¬ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Pretendard', 'Noto Sans KR', Arial, sans-serif; background: #f8f8f8; margin: 0; }
    .container { max-width: 100%; width: 100%; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px #eee; padding: 16px; box-sizing: border-box; }
    h2 { color: #21808c; text-align: center; margin-bottom: 24px; font-size: 1.5em; }
    .pdf-viewer { width: 100%; height: 60vh; min-height: 400px; border: 1px solid #ccc; border-radius: 8px; }
    .share-btn { 
      margin-top: 20px; 
      display: block; 
      width: 100%; 
      padding: 14px; 
      background: #1cc7b6; 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      font-size: 1em; 
      cursor: pointer;
      transition: background-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .share-btn:active {
      background: #189a8c;
      transform: scale(0.98);
    }
    .action-btns {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 18px;
    }
    .action-btns button {
      width: 100%;
      padding: 13px;
      background: #f5f5f5;
      color: #21808c;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .action-btns button:hover {
      background: #21808c;
      color: #fff;
    }
    @media (max-width: 600px) {
      .container { 
        padding: 12px; 
        border-radius: 0; 
        box-shadow: none; 
        margin: 0;
        max-width: 100%;
      }
      h2 { 
        font-size: 1.2em; 
        margin-bottom: 16px; 
        color: #21808c;
      }
      .pdf-viewer { 
        min-height: 300px; 
        height: 50vh; 
        border-radius: 6px;
      }
      .share-btn { 
        padding: 14px; 
        font-size: 1em; 
        font-weight: 500;
        margin-bottom: 8px;
      }
      .action-btns { 
        gap: 8px; 
        margin-top: 16px; 
      }
      .action-btns button { 
        padding: 12px; 
        font-size: 0.95em; 
        font-weight: 500;
      }
      /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ê°„ê²© ì¡°ì • */
      .share-btn[style*="margin-top"] {
        margin-top: 8px !important;
      }
    }
    
    /* ë§¤ìš° ì‘ì€ í™”ë©´ (320px ì´í•˜) */
    @media (max-width: 320px) {
      .container { padding: 8px; }
      h2 { font-size: 1.1em; }
      .pdf-viewer { min-height: 250px; height: 45vh; }
      .share-btn { padding: 12px; font-size: 0.9em; }
      .action-btns button { padding: 10px; font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PDF ë¯¸ë¦¬ë³´ê¸°</h2>
    <iframe id="pdf-frame" class="pdf-viewer" src="" allow="autoplay" onload="handlePdfLoad()" onerror="handlePdfError()"></iframe>
    <div id="pdf-error" style="display: none; text-align: center; padding: 40px; color: #666;">
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“„</div>
      <h3>PDF ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>PDF íŒŒì¼ì€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ í†µí•´ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <button class="share-btn" onclick="downloadPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
    <button class="share-btn" onclick="sharePDF()" style="margin-top: 10px; background: #21808c;">PDF ê³µìœ í•˜ê¸°</button>
    <button class="share-btn" onclick="openInGoogleDrive()" style="margin-top: 10px; background: #34a853;">
      <i class="fas fa-external-link-alt"></i>
      PDF íŒŒì¼ êµ¬ê¸€ë“œë¼ì´ë¸Œì—ì„œ ë³´ê¸°
    </button>
    <div class="action-btns">
      <button onclick="goBack()">í¸ì§‘í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button onclick="goHome()">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button onclick="goDrive()">êµ¬ê¸€ë“œë¼ì´ë¸Œ ë°”ë¡œê°€ê¸°</button>
    </div>
  </div>
  <script>
    // URLì—ì„œ id íŒŒë¼ë¯¸í„°ë¡œ PDF íŒŒì¼ IDë¥¼ ë°›ìŒ
    const urlParams = new URLSearchParams(window.location.search);
    const pdfId = urlParams.get('id'); // êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ID
    
    let fallbackAttempted = false;

    // êµ¬ê¸€ ë“œë¼ì´ë¸Œ PDF ë¯¸ë¦¬ë³´ê¸° ë§í¬ ìƒì„± (ë” ì•ˆì •ì ì¸ ë°©ë²•)
    if (pdfId) {
      // ë°©ë²• 1: Google Drive ì§ì ‘ ë·°ì–´ ì‚¬ìš©
      const pdfUrl = `https://drive.google.com/file/d/${pdfId}/preview`;
      document.getElementById('pdf-frame').src = pdfUrl;
      console.log('PDF ë¯¸ë¦¬ë³´ê¸° URL:', pdfUrl);
    } else {
      document.getElementById('pdf-frame').src = '';
    }
    
    // PDF ë¡œë“œ ì„±ê³µ ì²˜ë¦¬
    function handlePdfLoad() {
      console.log('PDF ë¡œë“œ ì„±ê³µ');
      document.getElementById('pdf-error').style.display = 'none';
      document.getElementById('pdf-frame').style.display = 'block';
    }
    
    // PDF ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
    function handlePdfError() {
      console.log('PDF ë¡œë“œ ì‹¤íŒ¨');
      if (!fallbackAttempted) {
        fallbackAttempted = true;
        // ë°©ë²• 2: Google Docs Viewerë¡œ ì¬ì‹œë„
        const iframe = document.getElementById('pdf-frame');
        iframe.src = `https://docs.google.com/viewer?url=https://drive.google.com/uc?export=download&id=${pdfId}&embedded=true`;
        console.log('Fallback 1 ì‹œë„: Google Docs Viewer');
      } else {
        // ë°©ë²• 3: ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ë¡œ ì¬ì‹œë„
        const iframe = document.getElementById('pdf-frame');
        iframe.src = `https://drive.google.com/uc?export=view&id=${pdfId}`;
        console.log('Fallback 2 ì‹œë„: ì§ì ‘ ë·°ì–´');
        
        // 3ì´ˆ í›„ì—ë„ ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        setTimeout(() => {
          if (document.getElementById('pdf-frame').style.display !== 'none') {
            document.getElementById('pdf-frame').style.display = 'none';
            document.getElementById('pdf-error').style.display = 'block';
            console.log('ëª¨ë“  ë¯¸ë¦¬ë³´ê¸° ë°©ë²• ì‹¤íŒ¨, ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ');
          }
        }, 3000);
      }
    }

    // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadPDF() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
      const directDownloadUrl = `https://drive.google.com/uc?export=download&id=${pdfId}`;
      
      // ìƒˆ ì°½ì—ì„œ PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ì—´ê¸°
      const downloadWindow = window.open(directDownloadUrl, '_blank');
      
      if (downloadWindow) {
        // ìƒˆ ì°½ì´ ì—´ë ¸ìœ¼ë©´ ì ì‹œ í›„ ë‹«ê¸° (ì„ íƒì‚¬í•­)
        setTimeout(() => {
          downloadWindow.close();
        }, 2000);
      }
    }

    // ê³µìœ  ë²„íŠ¼ (PDF íŒŒì¼ ì§ì ‘ ê³µìœ )
    function sharePDF() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
      const directDownloadUrl = `https://drive.google.com/uc?export=download&id=${pdfId}`;
      
      if (navigator.share) {
        // ëª¨ë°”ì¼ ê³µìœ  API ì‚¬ìš©
        navigator.share({
          title: 'ê²¬ì ì„œ PDF',
          text: 'ê²¬ì ì„œ PDF íŒŒì¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.',
          url: directDownloadUrl
        }).catch((error) => {
          console.log('ê³µìœ  ì‹¤íŒ¨:', error);
          // ê³µìœ  ì‹¤íŒ¨ ì‹œ ë‹¤ìš´ë¡œë“œ ë§í¬ ë³µì‚¬
          copyToClipboard(directDownloadUrl);
        });
      } else {
        // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ë§í¬ ë³µì‚¬
        copyToClipboard(directDownloadUrl);
      }
    }

    // í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          alert('PDF ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në§í¬: ' + text);
        }).catch(() => {
          // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë³µì‚¬
          manualCopy(text);
        });
      } else {
        // êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›
        manualCopy(text);
      }
    }

    // ìˆ˜ë™ ë³µì‚¬ í•¨ìˆ˜ (êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›)
    function manualCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('PDF ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në§í¬: ' + text);
      } catch (err) {
        alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n\n' + text);
      }
      document.body.removeChild(textArea);
    }

    function goBack() {
      // URLì—ì„œ fileId íŒŒë¼ë¯¸í„°ë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ localStorageì—ì„œ estimateDataì˜ fileId ì‚¬ìš©
      let fileId = urlParams.get('fileId');
      if (!fileId) {
        try {
          const estimateData = JSON.parse(localStorage.getItem('estimateData') || '{}');
          fileId = estimateData.fileId;
        } catch (e) {}
      }
      if (fileId) {
        window.location.href = `estimate_form.html?id=${fileId}`;
      } else {
        window.location.href = 'estimate_form.html';
      }
    }
    function goHome() {
      window.location.href = 'https://bitekps.com/auto-quote';
    }
    function goDrive() {
      window.open('https://drive.google.com/drive/folders/1aRR0m61B_a4B6ag76GrYt-8bdxiyYRC6?usp=sharing', '_blank');
    }

    // PDF íŒŒì¼ì„ Google Driveì—ì„œ ì§ì ‘ ë³´ê¸°
    function openInGoogleDrive() {
      if (!pdfId) {
        alert('PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // Google Driveì—ì„œ PDF íŒŒì¼ ì§ì ‘ ë³´ê¸° ë§í¬ ìƒì„±
      const driveViewUrl = `https://drive.google.com/file/d/${pdfId}/view?usp=sharing`;
      
      // ìƒˆ ì°½ì—ì„œ Google Drive ë·°ì–´ ì—´ê¸°
      window.open(driveViewUrl, '_blank');
    }
  </script>
</body>
</html>
